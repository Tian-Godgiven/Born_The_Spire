# 房间系统实现总结

## 一、核心架构

### 1. 统一概念：Room
- **所有内容都是 Room**：战斗、事件、休息点、黑市、房间选择
- 房间类型：`"battle" | "event" | "pool" | "blackStore" | "roomSelect"`
- 房间生命周期：`enter() → process() → complete() → exit()`

### 2. 关键文件位置

```
src/core/objects/room/
├── Room.ts                    # 房间基类
├── BattleRoom.ts             # 战斗房间
├── EventRoom.ts              # 事件房间
├── PoolRoom.ts               # 休息点（汲取/升级/染血）
├── BlackStoreRoom.ts         # 黑市房间
└── RoomSelectRoom.ts         # 房间选择（特殊房间）

src/core/objects/system/
├── FloorManager.ts           # 楼层管理器
├── RoomGenerationRules.ts    # 房间生成规则
└── GameRun.ts                # 游戏运行（已集成楼层系统）

src/static/list/
├── room/roomList.ts          # 房间配置列表
├── event/eventList.ts        # 事件配置列表
├── event/eventEffectMap.ts   # 事件效果映射表
└── blackStore/blackStoreItemPool.ts  # 黑市物品池

src/static/registry/
└── roomRegistry.ts           # 房间注册表（支持 Mod）
```

## 二、楼层系统

### 工作原理
1. **每进入一个房间，楼层 +1**
2. **记录房间历史**，影响下次房间生成
3. **规则驱动**：根据历史自动调整房间概率

### 关键代码
```typescript
// GameRun.ts
async enterRoom(room: Room) {
    this.floorManager.recordRoom(room.type)  // 记录房间类型
    this.floorManager.advanceFloor()         // 楼层 +1
    this.towerLevel = this.floorManager.getCurrentFloor()
    await room.enter()
}
```

### 生成规则示例
```typescript
// RoomGenerationRules.ts
{
    name: "连续3次非战斗后强制战斗",
    priority: 100,
    condition: (context) => context.consecutiveNonBattles >= 3,
    effect: () => "battle"  // 强制返回战斗类型
}
```

### 规则上下文
- `currentFloor`: 当前楼层
- `consecutiveBattles`: 连续战斗次数
- `consecutiveNonBattles`: 连续非战斗次数
- `floorsSinceLastPool`: 距离上次休息点的楼层数
- `floorsSinceLastBlackStore`: 距离上次黑市的楼层数
- `floorsSinceLastEvent`: 距离上次事件的楼层数

## 三、黑市系统

### 功能清单
- ✅ **购买**：5个随机器官 + 3个随机遗物 + 3个随机药水
- ✅ **出售器官**：售价约为购买价的 50-70%
- ✅ **出售生命值**：带贬值机制

### 贬值机制
```typescript
// 基础价格：1生命 = 5金钱
// 每次售出后降低 20%
价格 = 基础价格 × 0.8^(售出次数)

第1次: 5金/生命
第2次: 4金/生命
第3次: 3.2金/生命
...
```

### 物品池系统
```typescript
// blackStoreItemPool.ts
export const blackStoreOrganPool: ItemPoolConfig<OrganMap> = {
    items: [],
    weights: []
}

// Mod 制作者可以添加物品
addOrganToBlackStorePool(organ, weight)
addRelicToBlackStorePoolc, weight)
addPotionToBlackStorePool(potion, weight)

// 权重随机选择（不重复）
selectRandomItemsFromPool(pool, count, allowDuplicate)
```

### 初始化
```typescript
// run.ts - 游戏启动时自动初始化
initBlackStoreItemPools()
```

## 四、事件系统

### 数据驱动设计
```typescript
// eventList.ts
{
    key: "event_mysterious_merchant",
    title: "神秘商人",
    description: "一个神秘的商人出现在你面前...",
    options: [
        {
            title: "购买神秘药水（花费 50 金钱）",
            effects: [
                { key: "loseGold", params: { amount: 50 } },
                { key: "gainRandomPotion", params: { count: 1 } }
            ]
        },
        {
            title: "离开",
            effects: []
        }
    ]
}
```

### 原子效果映射表
```typescript
// eventEffectMap.ts
export const eventEffectMap: Record<string, EventEffectFunc> = {
    "gainMaterial": async (params) => { /* 获得物质 */ },
    "loseGold": async (params) => { /* 失去金钱 */ },
    "healHealth": async (params) => { /* 回复生命 */ },
    "gainRelic": async (params) => { /* 获得遗物 */ },
    // ... 20+ 种效果
}
```

### 复杂交互支持
- 可以指定自定义 Vue 组件（转盘、卡牌配对等）
- 支持 `customCallback` 自定义逻辑

## 五、房间选择系统

### RoomSelectRoom（特殊房间）
```typescript
// 自动生成 3 个房间选项
constructor(config: RoomSelectRoomConfig) {
    const roomKeys = config.roomKeys ??
        nowGameRun.value.generateNextFloorRoomOptions(3)

    this.availableRooms = roomKeys.map(key =>
        roomRegistry.createRoom(key, this.targetLayer))
}
```

### 选择流程
1. 进入 RoomSelectRoom（不增加楼层）
2. 玩家选择一个房间
3. 完成 RoomSelectRoom
4. 进入选中的房间（楼层 +1）

## 六、Mod 支持

### 房间注册
```typescript
// roomRegistry.ts
roomRegistry.registerRoomType("customRoom", CustomRoomClass)
roomRegistry.registerRoomConfig({
    key: "my_custom_room",
    type: "customRoom",
    name: "我的自定义房间",
    // ...
})
```

### 事件效果扩展
```typescript
// 添加自定义效果
eventEffectMap["myCustomEffect"] = async (params) => {
    // 自定义逻辑
}
```

### 房间生成规则扩展
```typescript
// 添加自定义规则
addRoomGenerationRule({
    name: "我的规则",
    priority: 50,
    condition: (context) => { /* ... */ },
    effect: (weights) => { /* ... */ }
})
```

### 黑市物品池扩展
```typescript
// 添加自定义物品到黑市
addOrganToBlackStorePool(myOrgan, 2)  // 权重为 2
addRelicToBlackStorePool(myRelic, 1)
addPotionToBlackStorePool(myPotion, 3)
```

## 七、测试要点

### 1. 楼层系统测试
- [ ] 进入房间后楼层是否 +1
- [ ] 连续 3 次非战斗后是否强制战斗
- [ ] 房间历史是否正确记录
- [ ] 房间选择概率是否符合规则

### 2. 黑市测试
- [ ] 是否生成 5 器官 + 3 遗物 + 3 药水
- [ ] 购买功能是否正常
- [ ] 出售器官功能是否正常
- [ ] 出售生命值是否有贬值（多次测试）
- [ ] 物品是否不重复

### 3. 事件系统测试
- [ ] 事件描述是否正确显示
- [ ] 选项效果是否正确执行
- [ ] 多个效果是否按顺序执行
- [ ] 自定义组件是否正常工作

### 4. 房间选择测试
- [ ] 是否显示 3 个房间选项
- [ ] 选择后是否正确进入房间
- [ ] 楼层是否在进入选中房间后 +1

### 5. 休息点测试
- [ ] 汲取：是否获得物质
- [ ] 升级：是否打开升级界面
- [ ] 染血：是否正确执行

## 八、已知 TODO

### BlackStoreRoom.ts
```typescript
// TODO: 检查玩家金钱是否足够
// TODO: 扣除金钱
// TODO: 给予商品（器官/遗物/药水）
// TODO: 移除器官
// TODO: 扣除生命值
// TODO: 根据器官等级和稀有度计算价格
```

### PoolRoom.ts
```typescript
// TODO: 实现汲取功能（获得物质）
// TODO: 实现升级功能（打开升级界面）
// TODO: 实现染血功能
```

### BattleRoom.ts
```typescript
// TODO: 实现战斗奖励系统
```

## 九、启动命令

```bash
cd born_the_spire
npm run tauri dev  # 启动开发模式
```

## 十、调试技巧

```typescript
// 全局暴露的调试对象
window.nowPlayerDebug  // 当前玩家
window.nowGameRun      // 当前游戏运行（需要手动暴露）

// 日志函数
newLog(["消息"])       // 游戏日志
newError(["错误"])     // 错误日志
console.log()          // 浏览器控制台
```

---

**总结**：实现了完整的房间系统、楼层系统、黑市系统和事件系统，所有系统都支持 Mod 扩展。核心概念统一为 Room，避免玩家混淆。
