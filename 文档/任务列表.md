[toc]

# 任务优先级规划

## 🔴 严重（阻塞性问题/核心功能缺失）

### Bug修复 - 事务系统
**影响**：可能导致游戏逻辑错误，触发器失效
  修复触发器产生的事件可能不会被收集到同一事务的bug
  验证新队列系统下的事件收集是否正确

### 回合系统与战斗流程
**影响**：核心战斗机制不完整，影响所有卡牌和器官的功能
  完善抽牌机制（通过trigger系统实现）
  确保回合行为正确触发相关触发器
  卡牌使用取消时的回卷机制（卡牌回到手牌而不是丢弃）

### 战斗房间系统 - 核心流程
**影响**：战斗无法正常结束，玩家无法获得奖励
  实现战斗失败逻辑（游戏结束/重试/其他）
  战斗失败UI提示
  实现器官选择界面（普通战斗和精英战斗：随机3选1）
  实现Boss器官选择界面（所有器官可选）

---

## 🟠 高优先级（影响游戏可玩性）

### 事件效果系统
**影响**：事件房间无法正常工作，大量事件无效果
**当前状态**：只实现了 `nothing`，其他17个效果全部缺失
  gainMaterial, loseMaterial - 物质系统
  gainGold, loseGold - 金钱系统
  healHealth, loseHealth, gainMaxHealth - 生命系统
  gainRelic, gainPotion, gainCard - 物品获取
  removeCard, upgradeCard - 卡牌管理
  gainOrgan, removeOrgan - 器官管理
  各种随机奖励效果

### 器官系统完善
**影响**：核心玩法机制不完整，器官无法正常使用
  实现质量系统（当前质量、最大质量、质量归0触发损坏）
  实现售卖方法（sellOrgan，获得金钱）
  完善修复方法（repairOrgan，添加物质消耗和质量恢复）
  创建器官相关 effect（damageOrgan, healOrgan 等）
  确认设计：upgradeOrgan 当前消耗生命而非物质，是否需要修改？

### 随机种子系统
**影响**：无法保证游戏公平性，SL大法失效，bug无法复现
  实现全局随机种子系统
  为每局游戏生成唯一的种子
  保证 SL（存档/读档）后随机结果不变
  支持手动设置种子（用于测试/复现）
  应用到：事件随机、奖励抽取、敌人行为、伤害波动

---

## 🟡 中优先级（影响体验但不阻塞）

### 战斗房间系统 - 奖励扩展
**影响**：奖励类型不完整，但不阻塞基础流程
  实现遗物选择界面（精英战斗：随机1个）
  实现Boss遗物选择界面（随机3选1）
  器官吞噬选项（获得额外物质）

### UI与显示系统
**影响**：用户体验，但不影响功能
  卡牌显示的动态参数更新（力量、易伤等实时显示在卡面上）
  当目标改变时，卡牌显示的参数动态更新
  卡牌的tooltip显示（鼠标悬停显示详细信息）
  器官的详情弹窗

### 层级系统
**影响**：部分完成，剩余内容不阻塞基础游戏
  层级选择UI（打败Boss后选择下一层级）
  强化精英战斗（印记获得方式2）
  宝箱房间（印记获得方式3）

### 词条与临时效果系统
**影响**：扩展性功能，不影响基础玩法
  实现器官的词条系统
  实现临时器官系统（战斗内获得的临时器官）
  玩家可以主动选择使用器官效果
  玩家可以主动选择使用遗物效果

### 器官系统 - 扩展功能
**影响**：扩展功能，基础功能已可用
  添加 mass 属性（质量系统）
  实现 maxLevel 限制（当前未强制执行）
  添加器官示例数据（不同等级、稀有度的器官）
  测试完整流程（获取→使用→损坏→修复→升级→吞噬）

---

## 🟢 低优先级（锦上添花）

### 进阶系统（难度系统）
**影响**：难度系统，可以后期添加
  实现进阶系统框架
  进阶系统可以修改关键/唯一触发器（如"层级开始时xxx"）
  设计并实现多个进阶选项

### 测试与验证
**影响**：持续进行，不阻塞开发
  测试遗物的获得和使用流程
  测试药水的使用和丢弃流程

### 开发工具
**影响**：辅助工具，提升开发效率
  实现调试工具：查看对象身上的触发器
  调试工具：显示触发器来源和介绍
  调试工具：移除触发器功能（带撤销）
  为游戏初始化添加日志记录（汇总显示初始器官、卡牌、遗物）

### 体验优化
**影响**：交互优化，不影响功能
  卡牌拖拽使用（替代当前的点击使用）

---

# 详细任务列表

当前任务：

## 器官系统完善（优先级待定）⚠️ 部分完成

### 基础属性系统
- [ ] 添加 mass 属性（质量系统）
- [ ] 实现 maxLevel 限制（当前未强制执行）
- [ ] 实现质量系统（当前质量、最大质量、质量归0触发损坏）

### 行为方法
- [ ] 实现售卖方法（sellOrgan，获得金钱）
- [ ] 完善修复方法（repairOrgan，添加物质消耗和质量恢复）
- [ ] ⚠️ 确认设计：upgradeOrgan 当前消耗生命而非物质，是否需要修改？

### 完善与测试
- [ ] 创建器官相关 effect（damageOrgan, healOrgan 等）
- [ ] 添加器官示例数据（不同等级、稀有度的器官）
- [ ] 测试完整流程（获取→使用→损坏→修复→升级→吞噬）

---

## 战斗房间系统 ⚠️ 部分完成

### 奖励选择UI
- [ ] 实现器官选择界面（普通战斗和精英战斗：随机3选1）
- [ ] 实现Boss器官选择界面（所有器官可选）
- [ ] 实现遗物选择界面（精英战斗：随机1个）
- [ ] 实现Boss遗物选择界面（随机3选1）
- [ ] 器官吞噬选项（获得额外物质）

### 战斗失败处理
- [ ] 实现战斗失败逻辑（游戏结束/重试/其他）
- [ ] 战斗失败UI提示

**已实现部分**：
- ✅ BattleRoom 基础类（生命周期、敌人生成）
- ✅ 三种战斗类型（normal、elite、boss）
- ✅ 物质奖励计算和发放
- ✅ 器官收集和随机抽取逻辑

---

## 随机种子系统 ⚠️ 未开始

### 功能需求
- [ ] 实现全局随机种子系统
- [ ] 为每局游戏生成唯一的种子
- [ ] 保证 SL（存档/读档）后随机结果不变
- [ ] 支持手动设置种子（用于测试/复现）

### 应用场景
- 事件房间的随机效果
- 奖励池的随机抽取
- 敌人行为的随机性
- 战斗中的随机伤害波动

### 实现要点
- 使用确定性随机算法（如 SeededRandom）
- 种子保存在 GameRun 中
- 每次随机操作从种子派生新状态

---

## 层级系统 ⚠️ 部分完成

### 待实现
- [ ] 层级选择UI（打败Boss后选择下一层级）
- [ ] 强化精英战斗（印记获得方式2）
- [ ] 宝箱房间（印记获得方式3）

---

## 事件效果系统 ⚠️ 大量 TODO

位置：`src/static/list/room/event/eventEffectMap.ts`

### 待实现效果
- [ ] `gainMaterial` - 获得物质
- [ ] `loseMaterial` - 失去物质
- [ ] `gainGold` - 获得金钱
- [ ] `loseGold` - 失去金钱
- [ ] `healHealth` - 回复生命
- [ ] `loseHealth` - 失去生命
- [ ] `gainMaxHealth` - 增加最大生命
- [ ] `gainRelic` - 获得遗物
- [ ] `gainPotion` - 获得药水
- [ ] `gainCard` - 获得卡牌
- [ ] `removeCard` - 移除��牌
- [ ] `upgradeCard` - 升级卡牌
- [ ] `gainOrgan` - 获得器官
- [ ] `removeOrgan` - 移除器官
- [ ] `gainRandomRelic` - 获得随机遗物
- [ ] `gainRandomPotion` - 获得随机药水
- [ ] `gainRandomCard` - 获得随机卡牌
- [ ] `gainRandomReward` - 获得随机奖励

**已实现**：
- ✅ `nothing` - 无效果

---

## 回合系统与战斗流程 ✅ 已完成

### 回合行为
- [x] 完善弃牌机制（通过trigger系统实现）
- [x] 完善抽牌机制（通过trigger系统实现）
- [x] 确保回合行为正确触发相关触发器

### 战斗交互
- [x] 卡牌使用取消时的回卷机制（卡牌回到手牌而不是丢弃）
- [x] 卡牌选择UI（从手牌选择、筛选等）

**已实现部分**：
- ✅ 回合结束弃牌触发器（使用 importantKey 和 onlyKey，可被替换）
- ✅ 回合开始抽牌触发器（数量由 draw-per-turn 属性决定，支持牌堆不足时自动洗牌）
- ✅ turnStart 和 turnEnd 事件正确触发
- ✅ 玩家回合开始时恢复能量
- ✅ 卡牌使用取消回卷（右键取消选择目标时，卡牌留在手牌；能量不足时，卡牌留在手牌）
- ✅ 卡牌选择UI组件（CardChoice.vue + showCardChoice hook，支持单选/多选/筛选）

---

## UI与显示系统 ⚠️ 中优先级

### 动态参数显示
- [ ] 卡牌显示的动态参数更新（力量、易伤等实时显示在卡面上）
- [ ] 当目标改变时，卡牌显示的参数动态更新

### 提示与详情
- [ ] 卡牌的tooltip显示（鼠标悬停显示详细信息）
- [ ] 器官的详情弹窗

---

## 词条与临时效果系统 ⚠️ 中优先级

### 器官词条
- [ ] 实现器官的词条系统
- [ ] 实现临时器官系统（战斗内获得的临时器官）

### 主动使用
- [ ] 玩家可以主动选择使用器官效果
- [ ] 玩家可以主动选择使用遗物效果

---

## 进阶系统（难度系统）⚠️ 未开始

### 功能需求
- [ ] 实现进阶系统框架
- [ ] 进阶系统可以修改关键/唯一触发器（如"层级开始时xxx"）
- [ ] 设计并实现多个进阶选项

---

## 测试与验证 ⚠️ 待测试

### 物品系统测试
- [ ] 测试遗物的获得和使用流程
- [ ] 测试药水的使用和丢弃流程

---

## Bug修复与优化 ⚠️ 潜在问题

### 事务系统
- [ ] 修复触发器产生的事件可能不会被收集到同一事务的bug

---

## 开发工具 ⚠️ 低优先级

### 调试工具
- [ ] 实现调试工具：查看对象身上的触发器
- [ ] 调试工具：显示触发器来源和介绍
- [ ] 调试工具：移除触发器功能（带撤销）

### 初始化日志
- [ ] 为游戏初始化添加日志记录（汇总显示初始器官、卡牌、遗物）

---

## 体验优化 ⚠️ 低优先级

### 交互优化
- [ ] 卡牌拖拽使用（替代当前的点击使用）

---

## Mod 系统扩展 ⚠️ 未开始

### 机制系统命名规范
- [ ] 在 Mod 加载系统中添加机制命名规范检查
- [ ] 官方机制可以使用简短名字（如 "armor", "shield"）
- [ ] Mod 机制必须带前缀（如 "mod_modname_xxx"）
- [ ] 注册时检查 Mod 机制是否符合命名规范
- [ ] 如果不符合，给出警告或拒绝注册

**相关文件**：
- `src/static/registry/mechanismRegistry.ts`（添加命名检查）
- Mod 加载系统（待实现）



