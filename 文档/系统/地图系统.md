# 地图系统 Map System

地图系统负责生成和管理游戏的楼层地图，提供类似 Slay the Spire 的多路径探索体验。

## 核心概念

地图系统由以下几个部分组成：

MapNode（地图节点）
  每个节点代表一个房间
  包含房间类型、连接关系、状态等信息

FloorMap（楼层地图）
  管理整个楼层的所有节点
  处理节点连接、路径查找、状态更新

MapGenerator（地图生成器）
  根据配置生成地图
  应用约束规则、验证地图有效性

FloorMapConfig（地图配置）
  定义地图结构、房间分配、约束规则等

## 地图节点 MapNode

### 数据结构

```typescript
interface MapNode {
  id: string              // 节点唯一标识，格式："{layer}-{index}"
  layer: number           // 所在层级（0-based）
  roomType: RoomType      // 房间类型
  roomKey: string         // 具体房间key（lazy类型可能为空）
  x: number               // 水平位置（0.0-1.0）
  connections: string[]   // 连接的下层节点ID列表
  state: NodeState        // 节点状态
}

type NodeState = "locked" | "available" | "current" | "completed"
```

### 节点状态

locked
  未解锁，玩家无法前往

available
  可前往，玩家可以点击进入

current
  当前位置

completed
  已完成

### 创建节点

```typescript
import { createMapNode } from "@/core/objects/system/map/MapNode"

const node = createMapNode({
  id: "0-0",
  layer: 0,
  roomType: "battle",
  roomKey: "battle_normal_slime",
  x: 0.5
})
```

## 楼层地图 FloorMap

### 基本操作

```typescript
import { FloorMap } from "@/core/objects/system/map/FloorMap"

// 创建地图
const map = new FloorMap(15)  // 15层

// 添加节点
map.addNode(node)

// 获取节点
const node = map.getNode("0-0")

// 获取某一层的所有节点
const layer0 = map.getLayer(0)

// 获取所有节点
const allNodes = map.getAllNodes()
```

### 地图导航

```typescript
// 初始化地图（设置起始节点）
map.initialize("0-0")

// 获取当前节点
const current = map.getCurrentNode()

// 获取可前往的节点
const nextNodes = map.getNextNodes()

// 移动到下一个节点
const success = map.moveToNode("1-2")
```

### 路径查找

```typescript
// 获取节点的父节点
const parents = map.getParentNodes(node)

// 获取从某节点开始的所有路径
const paths = map.getAllPaths("0-0")

// 验证地图连通性
const isValid = map.validateConnectivity("0-0")
```

### 序列化

```typescript
// 序列化为JSON
const json = map.serialize()

// 从JSON反序列化
const map = FloorMap.deserialize(json)
```

## 地图生成器 MapGenerator

### 基本使用

```typescript
import { MapGenerator } from "@/core/objects/system/map/MapGenerator"
import type { FloorMapConfig } from "@/core/types/FloorMapConfig"

const config: FloorMapConfig = {
  layers: 15,
  nodesPerLayer: { min: 3, max: 7 },
  connectionDensity: { min: 1, max: 3 },
  roomTypeWeights: {
    battle: 50,
    eliteBattle: 10,
    event: 20,
    pool: 10,
    blackStore: 10
  },
  roomPools: {
    battles: ["battle_1", "battle_2"],
    events: ["event_1", "event_2"],
    // ...
  }
}

const generator = new MapGenerator(config)
const map = generator.generate()
```

### 延迟分配房间key

```typescript
// 对于lazy类型（battle、event），在玩家进入时分配
const roomKey = generator.assignLazyRoomKey(node)
node.roomKey = roomKey
```

## 地图配置 FloorMapConfig

### 配置结构

地图配置分为四个部分：

基础结构
  layers: 总层数
  nodesPerLayer: 每层节点数范围
  nodeCountRules: 节点数量规则（高级）
  connectionDensity: 连接密度

房间分配
  roomTypeWeights: 默认房间类型权重
  layerSpecificWeights: 层级特定权重
  layerLayouts: 层级布局（完全控制）
  roomAssignmentStrategy: 分配策略

约束规则
  constraints.global: 全局约束（数量、间隔）
  constraints.placement: 放置规则（父母、兄弟）

其他配置
  validationStrategy: 验证策略
  nodePositionConfig: 节点位置配置
  roomPools: 房间池
  seed: 随机种子（可选）

### 基础结构配置

```typescript
{
  layers: 15,

  nodesPerLayer: {
    min: 3,
    max: 7
  },

  nodeCountRules: {
    startLayer: 3,              // 起点层3个节点
    useDynamicMiddleRange: true, // 中间层动态范围
    bossLayer: 1                // Boss层1个节点
  },

  connectionDensity: {
    min: 1,
    max: 3
  }
}
```

### 房间分配配置

```typescript
{
  // 默认权重
  roomTypeWeights: {
    battle: 50,
    eliteBattle: 10,
    event: 20,
    pool: 10,
    blackStore: 10
  },

  // 层级特定权重
  layerSpecificWeights: {
    0: { battle: 100, eliteBattle: 0, event: 0, pool: 0, blackStore: 0 }
  },

  // 层级布局（完全控制）
  layerLayouts: {
    0: { roomTypes: ["battle", "battle", "battle"] },
    14: { roomKeys: ["battle_boss_default"] }
  },

  // 分配策略
  roomAssignmentStrategy: {
    lazyTypes: ["battle", "event"],
    eagerTypes: ["pool", "blackStore"],
    exhaustionStrategy: {
      battle: "reset",
      event: "reset"
    },
    trackUsedRooms: true
  }
}
```

### 约束规则配置

```typescript
{
  constraints: {
    global: {
      minCount: { pool: 3, blackStore: 2 },
      maxCount: { eliteBattle: 5 },
      minSpacing: { pool: 3 }
    },

    placement: {
      parent: {
        noSelfFollow: ["eliteBattle", "pool", "blackStore"]
      },

      sibling: {
        uniqueInLayer: ["eliteBattle", "pool", "blackStore"],
        maxSameTypeInLayer: { battle: 5, event: 2 },
        requireDiversity: true
      }
    }
  }
}
```

### 验证策略配置

```typescript
{
  validationStrategy: {
    maxRetries: 3,
    fixOnFailure: true,
    revalidateAfterFix: true,
    throwOnFailure: false
  }
}
```

## 游戏集成

### 生成地图

```typescript
import { nowGameRun } from "@/core/objects/game/run"

// 使用默认配置生成
const map = nowGameRun.floorManager.generateMap()

// 使用自定义配置生成
const map = nowGameRun.floorManager.generateMap({
  layers: 20,
  roomTypeWeights: { /* ... */ }
})
```

### 地图导航

```typescript
// 获取当前地图
const map = nowGameRun.floorManager.getCurrentMap()

// 获取当前节点
const node = nowGameRun.floorManager.getCurrentMapNode()

// 获取可前往的节点
const nextNodes = nowGameRun.floorManager.getNextMapNodes()

// 移动到节点
const success = nowGameRun.floorManager.moveToMapNode(nodeId)
```

### 房间进入流程

```typescript
import { enterRoom } from "@/core/objects/game/run"

// 点击地图节点后
async function onNodeClick(node: MapNode) {
  // 移动到节点
  nowGameRun.floorManager.moveToMapNode(node.id)

  // 如果是lazy类型，分配roomKey
  if (!node.roomKey) {
    const generator = nowGameRun.floorManager.getMapGenerator()
    node.roomKey = generator.assignLazyRoomKey(node)
  }

  // 进入房间
  await enterRoom(node.roomKey, node.layer)
}
```

## 种子系统

### 全局种子

种子存储在 GameRun 中，用于所有游戏内随机系统：

```typescript
// 游戏开始时自动生成种子
const gameRun = new GameRun()
console.log(gameRun.seed)  // "1234567890"

// 或指定种子
const gameRun = new GameRun("my_seed")

// 使用全局随机数生成器
const value = gameRun.rng.nextInt(1, 100)
const choice = gameRun.rng.choice(["A", "B", "C"])
```

### 种子与地图生成

```typescript
// 地图生成会自动使用 GameRun 的种子
const map = nowGameRun.floorManager.generateMap({
  seed: nowGameRun.seed
})

// 相同种子生成相同地图
const map1 = generateMap({ seed: "test" })
const map2 = generateMap({ seed: "test" })
// map1 和 map2 结构完全相同
```

### 派生随机数生成器

```typescript
// 为不同子系统创建独立的随机数生成器
const battleRng = gameRun.rng.derive("battle")
const lootRng = gameRun.rng.derive("loot")

// 它们的随机序列是独立但确定的
```

## UI集成

### 显示地图

```vue
<template>
  <MapOverlay ref="mapOverlay" />
</template>

<script setup>
import { ref, onMounted } from 'vue'
import MapOverlay from './MapOverlay.vue'
import { setShowMapCallback } from '@/core/hooks/step'

const mapOverlay = ref(null)

onMounted(() => {
  setShowMapCallback(() => mapOverlay.value?.show())
})
</script>
```

### 房间完成后显示地图

```typescript
import { completeAndGoNext } from '@/core/hooks/step'

async function onRoomComplete() {
  await completeAndGoNext()
  // 地图会自动显示
}
```

## 默认配置

项目提供了默认地图配置：

```typescript
import { defaultFloorMapConfig } from "@/core/types/FloorMapConfig"

// 15层地图
// 第0层：3个战斗房间
// 第7层：1个宝箱房间
// 第13层：3个休息点
// 第14层：Boss房间
```

配置特点：

结构
  15层（0-14）
  起始层3个节点，中间层2-5个节点，Boss层1个节点
  每个节点连接1-3个下层节点

房间分配
  第0层只有战斗
  其他层按默认权重分配
  战斗和事件延迟分配（不重复）
  休息和商店立即分配（使用种子）

约束
  至少3个休息点、2个商店
  最多5个精英战斗
  精英、休息、商店不能连续
  每层最多1个精英/休息/商店

## 相关文档

FloorMapConfig.usage.md
  地图配置详细使用指南

ValidationStrategy.usage.md
  验证策略配置指南

MapView.integration.md
  地图UI集成指南

FloorSelectRoom.usage.md
  楼层选择使用指南

MIGRATION_GUIDE.md
  从旧系统迁移指南

## 注意事项

种子系统
  种子是 GameRun 的全局属性
  不要在 FloorMapConfig 中设置 seed
  使用 nowGameRun.seed 和 nowGameRun.rng

房间池
  默认配置的房间池为空数组
  FloorManager 会自动从 roomRegistry 填充
  未来可以手动配置房间池

延迟分配
  battle 和 event 类型在进入时分配 roomKey
  pool 和 blackStore 类型在生成时分配 roomKey
  使用 seed + nodeId 确保确定性

地图验证
  生成后会自动验证约束
  验证失败会重试或修正
  可以通过 validationStrategy 自定义行为

## 实现文件

核心逻辑
  src/core/objects/system/map/MapNode.ts
  src/core/objects/system/map/FloorMap.ts
  src/core/objects/system/map/MapGenerator.ts
  src/core/objects/system/FloorManager.ts

配置类型
  src/core/types/FloorMapConfig.ts

工具类
  src/core/utils/SeededRandom.ts

UI组件
  src/ui/page/Scene/running/MapView.vue
  src/ui/page/Scene/running/MapOverlay.vue

Hook函数
  src/core/hooks/step.ts
