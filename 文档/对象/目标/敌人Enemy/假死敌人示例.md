# 假死敌人示例

展示如何创建一个"生命归0时进入假死状态，下回合复活并回复300生命"的敌人。

## 敌人数据配置

```typescript
// 在 enemyList.ts 中
{
    key: "enemy_fake_death",
    label: "不死守卫",
    status: {
        "max-health": 100
    },
    current: ["health", "isAlive"],
    organ: ["basic_attack_organ"],  // 基础攻击器官

    // 覆盖默认的死亡行为
    trigger: [
        {
            when: "after",
            how: "take",
            key: "healthReachMin",
            onlyKey: "default_death_on_health_zero",  // 覆盖默认触发器
            importantKey: "death_behavior",
            event: [{
                key: "fakeDeathStart",
                label: "进入假死状态",
                targetType: "self",
                effect: [
                    // 添加假死状态
                    {
                        key: "applyState",
                        params: {
                            stateKey: "fake_death",
                            stacks: 1
                        }
                    }
                ]
            }]
        },
        {
            // 回合开始时检查假死状态
            when: "after",
            how: "take",
            key: "turnStart",
            event: [{
                key: "checkFakeDeath",
                label: "检查假死状态",
                targetType: "self",
                // 这里需要条件判断，暂时用自定义效果
                effect: [{
                    key: "reviveFromFakeDeath",
                    params: {
                        healAmount: 300
                    }
                }]
            }]
        }
    ],

    behavior: {
        patterns: [],
        fallback: {
            action: {
                selector: { tags: ["attack"] },
                mode: "random"
            }
        }
    }
}
```

## 方案1：使用状态系统（推荐）

创建一个"假死"状态，在状态中处理复活逻辑：

```typescript
// 在 stateList.ts 中
{
    key: "fake_death",
    label: "假死",
    describe: ["下回合复活并回复300生命"],
    type: "buff",

    // 状态的触发器
    trigger: [{
        when: "after",
        how: "take",
        key: "turnStart",
        event: [{
            key: "reviveFromFakeDeath",
            label: "从假死中复活",
            targetType: "stateOwner",
            effect: [
                // 复活
                {
                    key: "revive",
                    params: {
                        healAmount: 300
                    }
                },
                // 移除假死状态
                {
                    key: "removeState",
                    params: {
                        stateKey: "fake_death",
                        stacks: 1
                    }
                }
            ]
        }]
    }]
}
```

这样敌人配置就简化为：

```typescript
{
    key: "enemy_fake_death",
    label: "不死守卫",
    status: {
        "max-health": 100
    },
    trigger: [
        {
            when: "after",
            how: "take",
            key: "healthReachMin",
            onlyKey: "default_death_on_health_zero",
            event: [{
                key: "enterFakeDeath",
                targetType: "self",
                effect: [{
                    key: "applyState",
                    params: {
                        stateKey: "fake_death",
                        stacks: 1
                    }
                }]
            }]
        }
    ],
    // ... 其他配置
}
```

## 方案2：使用自定义效果

如果需要更复杂的逻辑，可以创建专门的效果函数：

```typescript
// 在 lifeControl.ts 中添加
export const enterFakeDeath: EffectFunc = (event, effect) => {
    const { target } = event

    handleEventEntity(target, (t) => {
        if (!isEntity(t)) return

        newLog(["进入假死状态", t.label])

        // 添加假死标记
        t.isFakeDead = true

        // 添加假死状态（用于UI显示）
        doEvent({
            key: "applyState",
            source: t,
            target: t,
            effectUnits: [{
                key: "applyState",
                params: {
                    stateKey: "fake_death",
                    stacks: 1
                }
            }]
        })

        // 注册下回合复活的触发器
        const { remove } = t.appendTrigger({
            when: "after",
            how: "take",
            key: "turnStart",
            onlyKey: "fake_death_revive",
            callback: (turnEvent) => {
                newLog(["从假死中复活", t.label])

                // 复活
                doEvent({
                    key: "revive",
                    source: t,
                    target: t,
                    effectUnits: [{
                        key: "revive",
                        params: {
                            healAmount: 300
                        }
                    }]
                })

                // 移除假死状态
                doEvent({
                    key: "removeState",
                    source: t,
                    target: t,
                    effectUnits: [{
                        key: "removeState",
                        params: {
                            stateKey: "fake_death",
                            stacks: 1
                        }
                    }]
                })

                // 移除这个一次性触发器
                remove()
            }
        })
    })

    return true
}
```

然后在敌人配置中使用：

```typescript
{
    trigger: [{
        when: "after",
        how: "take",
        key: "healthReachMin",
        onlyKey: "default_death_on_health_zero",
        event: [{
            key: "enterFakeDeath",
            targetType: "self",
            effect: [{
                key: "enterFakeDeath",
                params: {}
            }]
        }]
    }]
}
```

## 方案3：纯数据驱动（最灵活）

使用条件效果系统（如果实现了的话）：

```typescript
{
    trigger: [
        {
            // 生命归0时添加假死状态
            when: "after",
            how: "take",
            key: "healthReachMin",
            onlyKey: "default_death_on_health_zero",
            event: [{
                targetType: "self",
                key: "applyState",
                effect: [{
                    key: "applyState",
                    params: {
                        stateKey: "fake_death",
                        stacks: 1
                    }
                }]
            }]
        },
        {
            // 回合开始时，如果有假死状态则复活
            when: "after",
            how: "take",
            key: "turnStart",
            condition: {
                hasState: {
                    target: "self",
                    stateKey: "fake_death"
                }
            },
            event: [
                {
                    targetType: "self",
                    key: "revive",
                    effect: [{
                        key: "revive",
                        params: {
                            healAmount: 300
                        }
                    }]
                },
                {
                    targetType: "self",
                    key: "removeState",
                    effect: [{
                        key: "removeState",
                        params: {
                            stateKey: "fake_death",
                            stacks: 1
                        }
                    }]
                }
            ]
        }
    ]
}
```

## 关键设计点

1. **onlyKey 机制** - 使用相同的 `onlyKey` 覆盖默认触发器
2. **状态系统** - 假死状态可以携带自己的触发器
3. **一次性触发器** - 复活后移除触发器，避免重复执行
4. **灵活性** - 可以通过数据配置实现各种复杂的死亡/复活逻辑

## 其他示例

### 多次复活

```typescript
{
    trigger: [{
        when: "after",
        how: "take",
        key: "healthReachMin",
        onlyKey: "default_death_on_health_zero",
        event: [{
            targetType: "self",
            key: "checkReviveCount",
            effect: [{
                key: "conditionalRevive",
                params: {
                    maxRevives: 3,  // 最多复活3次
                    healAmount: 100
                }
            }]
        }]
    }]
}
```

### 需要条件才能复活

```typescript
{
    trigger: [{
        when: "after",
        how: "take",
        key: "healthReachMin",
        onlyKey: "default_death_on_health_zero",
        event: [{
            targetType: "self",
            key: "conditionalDeath",
            effect: [{
                key: "checkAllyCount",  // 检查是否还有队友
                params: {
                    ifAlive: {
                        // 有队友：假死
                        effect: [{
                            key: "applyState",
                            params: { stateKey: "fake_death" }
                        }]
                    },
                    ifDead: {
                        // 没有队友：真死
                        effect: [{
                            key: "kill",
                            params: {}
                        }]
                    }
                }
            }]
        }]
    }]
}
```

## 总结

通过 `onlyKey` 机制覆盖默认的死亡触发器，可以实现：
- 假死
- 多次复活
- 条件复活
- 延迟死亡
- 死亡时触发特殊效果
- 等等...

所有这些都可以通过数据配置实现，无需修改核心代码！
