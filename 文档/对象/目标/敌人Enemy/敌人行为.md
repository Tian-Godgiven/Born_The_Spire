# 敌人行为配置系统

敌人行为配置系统定义了敌人如何从可用卡牌中选择要使用的卡牌。这是一个基于预设规则和条件判断的系统，不涉及机器学习或智能算法。

## 核心概念

### 行为模式 (BehaviorPattern)

一个行为模式定义了"在什么条件下，如何选择卡牌"。

```typescript
type BehaviorPattern = {
    condition?: BehaviorCondition  // 触发条件（可选）
    priority?: number              // 优先级（默认0，越大越优先）
    action: {
        selector: CardSelector     // 卡牌筛选器
        mode?: ActionMode          // 选择模式
        weights?: Record<string, number>  // 权重配置
        sequence?: string[]        // 序列配置
    }
    describe?: string              // 描述（用于调试）
}
```

### 行为配置 (EnemyBehaviorConfig)

一个敌人的完整行为配置，包含多个行为模式和默认行为。

```typescript
type EnemyBehaviorConfig = {
    patterns: BehaviorPattern[]    // 行为模式列表
    fallback?: BehaviorPattern     // 默认行为
}
```

## 条件系统

### 条件类型 (BehaviorCondition)

条件用于判断当前战斗状态，决定是否触发某个行为模式。

#### 1. 玩家血量条件

```typescript
playerHealth?: {
    below?: number   // 低于百分比（0-100）
    above?: number   // 高于百分比
    equals?: number  // 等于百分比
}
```

**示例：**
```typescript
// 玩家血量低于50%时触发
condition: {
    playerHealth: { below: 50 }
}

// 玩家血量高于80%时触发
condition: {
    playerHealth: { above: 80 }
}
```

#### 2. 敌人自身血量条件

```typescript
selfHealth?: {
    below?: number
    above?: number
    equals?: number
}
```

**示例：**
```typescript
// 自身血量低于30%时触发（濒死反击）
condition: {
    selfHealth: { below: 30 }
}
```

#### 3. 回合数条件

```typescript
turn?: {
    equals?: number              // 等于第几回合
    above?: number               // 大于第几回合
    below?: number               // 小于第几回合
    mod?: [number, number]       // [除数, 余数]
}
```

**示例：**
```typescript
// 第1回合触发
condition: {
    turn: { equals: 1 }
}

// 每3回合触发一次（第3、6、9...回合）
condition: {
    turn: { mod: [3, 0] }
}

// 第5回合之后触发
condition: {
    turn: { above: 5 }
}
```

#### 4. 状态层数条件

```typescript
hasState?: {
    target: "self" | "player"    // 检查目标
    stateKey: string             // 状态key
    stacks?: number              // 层数要求（默认>0）
}
```

**示例：**
```typescript
// 玩家有虚弱状态时触发
condition: {
    hasState: {
        target: "player",
        stateKey: "weak",
        stacks: 1
    }
}

// 自己有3层力量时触发
condition: {
    hasState: {
        target: "self",
        stateKey: "power",
        stacks: 3
    }
}
```

#### 5. 自定义条件函数

```typescript
custom?: (enemy: Enemy, player: Player) => boolean
```

**示例：**
```typescript
// 自定义复杂条件
condition: {
    custom: (enemy, player) => {
        // 玩家有格挡且敌人血量充足
        return player.current.block > 0 &&
               enemy.current.health.value > enemy.status.maxHealth.value * 0.5
    }
}
```

### 条件组合

多个条件之间是 **AND** 关系（同时满足）：

```typescript
condition: {
    playerHealth: { below: 50 },  // 玩家血量低于50%
    turn: { above: 3 }             // 且回合数大于3
}
// 两个条件都满足时才触发
```

## 行动模式

### 1. 随机模式 (random)

从筛选后的卡牌中随机选择。

```typescript
action: {
    selector: { tags: ["attack"] },
    mode: "random"
}
```

**说明：**
- 如果 `selector.random` 为 `true` 且指定了 `count`，会随机选择多张
- 如果 `selector.random` 为 `false`，会随机选择一张

### 2. 权重模式 (weighted)

根据权重随机选择卡牌。

```typescript
action: {
    selector: {},  // 不筛选，所有卡牌都可选
    mode: "weighted",
    weights: {
        "original_card_00001": 5,  // 打击：权重5
        "original_card_00002": 2,  // 消耗打击：权重2
        "original_card_00004": 1   // 肌肉强化：权重1
    }
}
```

**说明：**
- 权重越高，被选中的概率越大
- 未指定权重的卡牌默认权重为 1
- 总是选择一张卡牌

### 3模式 (sequence)

按预定义的顺序依次使用卡牌。

```typescript
action: {
    selector: {},
    mode: "sequence",
    sequence: [
        "original_card_00001",  // 第1回合：打击
        "original_card_00004",  // 第2回合：肌肉强化
        "original_card_00001"   // 第3回合：打击
    ]
}
```

**说明：**
- 按 `sequence` 数组的顺序依次使用
- 超出序列长度后，使用最后一张卡牌
- 如果序列中的卡牌不可用，使用第一张可用卡牌

### 4. 循环模式 (loop)

循环执行预定义的卡牌序列。

```typescript
action: {
    selector: {},
    mode: "loop",
    sequence: [
        "original_card_00001",  // 打击
        "original_card_00008"   // 淬毒
    ]
}
```\n- 按 `sequence` 数组循环使用：打击 → 淬毒 → 打击 → 淬毒 → ...
- 永远不会超出序列，会自动循环

## 优先级系统

当多个行为模式的条件都满足时，使用优先级最高的。

```typescript
patterns: [
    {
        priority: 10,  // 高优先级
        condition: { selfHealth: { below: 30 } },
        action: { /* 濒死反击 */ }
    },
    {
        priority: 5,   // 中优先级
        condition: { playerHealth: { below: 50 } },
        action: { /* 猛攻 */ }
    },
    {
        priority: 0,   // 低优先级（默认）
        condition: { turn: { mod: [2, 0] } },
        action: { /* 偶数回合行为 */ }
    }
]
```

**规则：**
- 优先级数字越大，越优先检查
- 相同优先级按数组顺序检查
- 找到第一个满足条件的模式后，不再检查其他模式

## 默llback)

当所有行为模式的条件都不满足时，使用默认行为。

```typescript
{
    patterns: [ /* ... */ ],
    fallback: {
        action: {
            selector: { tags: ["attack"] },
            mode: "random"
        },
        describe: "默认：随机攻击"
    }
}
```

**说明：**
- `fallback` 不需要 `condition`（总是满足）
- 如果没有 `fallback` 且所有条件都不满足，会随机选择一张卡牌

## 完整示例

### 示例1：简单敌人（随机攻击）

```typescript
const simpleEnemyBehavior: EnemyBehaviorConfig = {
    patterns: [],
    fallback: {
        action: {
            selector: { tags: ["attack"] },
            mode: "random"
        },
        describe: "随机使用攻击牌"
    }
}
```

### 示例2：中等敌人（条件行为）

```typescript
const mediumEnemyBehavior: EnemyBehaviorConfig = {
    patterns: [
        {
            // 玩家血量低时猛攻
            priority: 10,
            condition: {
                playerHealth: { below: 40 }
            },
            action: {
                selector: { tags: ["attack"] },
                mode: "weighted",
                weights: {
                    "original_card_00002": 3,  // 消耗打击：高权重
                    "original_card_00001": 1   // 普通打击：低权重
                }
            },
            describe: "玩家血量低于40%：猛攻"
        },
        {
            // 第1回合强化
            priority: 5,
            condition: {
                turn: { equals: 1 }
            },
            action: {
                selector: { tags: ["power"] },
                mode: "random"
            },
            describe: "第1回合：使用能力牌"
        }
    ],
    fallback: {
        action: {
            selector: {},
            mode: "random"
        },
        describe: "默认：随机行动"
    }
}
```

### 示例3：复杂敌人（脚本模式）

```typescript
const complexEnemyBehavior: EnemyBehaviorConfig = {
    patterns: [
        {
            // 濒死反击
         priority: 100,
            condition: {
                selfHealth: { below: 25 }
            },
            action: {
                selector: { tags: ["attack"] },
                mode: "weighted",
                weights: {
                    "original_card_00006": 10  // 末日：超高权重
                }
            },
            describe: "濒死反击：使用大招"
        },
        {
            // 每3回合强化
            priority: 50,
            condition: {
                turn: { mod: [3, 0] }
            },
            action: {
                selector: { tags: ["power"] },
                mode: "random"
            },
            describe: "每3回合：强化自身"
        },
        {
            // 固定循环：攻击 → 淬毒 → 攻击 → 淬毒
            priority: 0,
            action: {
                selector: {},
                mode: "loop",
                sequence: [
                    "original_card_00001",  // 打击
                    "original_card_00008"   // 淬毒
                ]
            },
            describe: "循环：攻击和淬毒交替"
        }
    ]
}
```

### 示例4：Boss敌人（多阶段）

```typescript
const bossEnemyBehavior: EnemyBehaviorConfig = {
    patterns: [
        {
            // 第一阶段（血量>66%）：蓄力
            priority: 10,
            condition: {
                selfHealth: { above: 66 }
            },
            action: {
                selector: { tags: ["power"] },
                mode: "random"
            },
            describe: "第一阶段：蓄力"
        },
        {
            // 第二阶段（33%-66%）：猛攻
            priority: 10,
            condition: {
                selfHealth: { above: 33, below: 66 }
            },
            action: {
                selector: { tags: ["attack"] },
                mode: "weighted",
                weights: {
                    "original_card_00005": 5,  // 旋风斩：AOE
                    "original_card_00001": 2   // 打击
                }
            },
            describe: "第二阶段：猛攻"
        },
        {
            // 第三阶段（<33%）：狂暴
            priority: 10,
            condition: {
                selfHealth: { below: 33 }
            },
            action: {
                selector: {},
                mode: "sequence",
                sequence: [
                    "original_card_00004",  // 强化
                    "original_card_00006",  // 末日
                    "original_card_00006"   // 末日
                ]
            },
            describe: "第三阶段：狂暴"
        }
    ],
    fallback: {
        action: {
            selector: { tags: ["attack"] },
            mode: "random"
        },
        describe: "默认攻击"
    }
}
```

## 使用方法

### 在敌人数据中配置

```typescript
// 在 enemyList.ts 中
const enemyList: EnemyMap[] = [{
    key: "enemy_001",
    label: "史莱姆",
    status: {
        maxHealth: 50
    },
    // 行为配置
    behavior: {
        patterns: [
            {
                condition: { turn: { equals: 1 } },
                action: {
                    selector: { tags: ["power"] },
                    mode: "random"
                }
            }
        ],
        fallback: {
            action: {
                selector: { tags: ["attack"] },
                mode: "random"
            }
        }
    }
}]
```

### 在战斗中使用

```typescript
import { selectAction } from "@/core/objects/system/EnemyBehavior"

// 敌人回合开始时
const selectedCards = selectAction(
    enemy.behavior,      // 行为配置
    enemy,               // 敌人实例
    player,              // 玩家实例
    currentTurnCount     // 当前回合数
)

// 设置意图
enemy.setIntent(selectedCards)

// 执行行动
// ...
```

## 调试技巧

### 1. 使用描述字段

为每个行为模式添加 `describe` 字段，方便调试：

```typescript
{
    condition: { playerHealth: { below: 50 } },
    action: { /* ... */ },
    describe: "玩家血量<50%：猛攻"  // 会在控制台输出
}
```

### 2. 检查条件

在控制台查看哪个条件被触发：

```
[EnemyBehavior] 使用行为模式: 玩家血量<50%：猛攻
```

### 3. 测试优先级

临时调整优先级，测试不同行为的触发顺序。

## 高级用法

### 不同条件使用不同行动模式

每个 `BehaviorPattern` 可以使用不同的行动模式，提供最大的灵活性：

```typescript
const flexibleEnemyBehavior: EnemyBehaviorConfig = {
    patterns: [
        {
            // 第1回合：使用顺序模式
            condition: { turn: { equals: 1 } },
            action: {
                mode: "sequence",
                sequence: ["buff_card", "attack_card"]
            },
            describe: "第1回合：固定顺序"
        },
        {
            // 玩家血量低：使用权重模式
            condition: { playerHealth: { below: 50 } },
            action: {
                mode: "weighted",
                weights: {
                    "strong_attack": 5,
                    "normal_attack": 1
                }
            },
            describe: "玩家血量低：倾向强攻"
        },
        {
            // 每3回合：使用循环模式
            condition: { turn: { mod: [3, 0] } },
            action: {
                mode: "loop",
                sequence: ["attack", "defend"]
            },
            describe: "每3回合：攻防循环"
        }
    ],
    fallback: {
        action: {
            mode: "random",
            selector: { tags: ["attack"] }
        },
        describe: "默认：随机攻击"
    }
}
```

**说明：**
- 每个回合只会触发**一个** pattern（第一个满足条件的）
- 不同回合可以触发不同的 pattern，使用不同的模式
- 通过优先级控制哪个条件优先检查

### 一个回合多个行动

如果需要敌人在一个回合内执行多个行动，有两种方式：

#### 方式1：设置每回合行动次数

```typescript
// 在敌人数据中
{
    key: "boss_001",
    label: "双头龙",
    status: {
        maxHealth: 200,
        "actions-per-turn": 2  // 每回合行动2次
    },
    behavior: {
        patterns: [ /* ... */ ]
    }
}
```

**效果：**
- 敌人每回合会执行2次行动
- 每次行动都会重新根据 `behavior` 选择卡牌
- 两次行动可能选择不同的卡牌（取决于条件）

#### 方式2：一次选择多张卡牌

```typescript
action: {
    selector: {
        tags: ["attack"],
        count: 2,      // 选择2张卡牌
        random: true   // 随机选择
    },
    mode: "random"
}
```

**效果：**
- 一次行动选择多张卡牌
- 这些卡牌会依次打出
- 适合"连击"类型的敌人

### 组合使用示例

```typescript
const advancedBossBehavior: EnemyBehaviorConfig = {
    patterns: [
        {
            // 第一阶段：每回合2次行动，使用权重模式
            priority: 10,
            condition: { selfHealth: { above: 50 } },
            action: {
                mode: "weighted",
                selector: { tags: ["attack", "skill"] },
                weights: {
                    "multi_attack": 3,  // 多段攻击
                    "buff_self": 2      // 自我强化
                }
            },
            describe: "第一阶段：稳健进攻"
        },
        {
            // 第二阶段：狂暴，使用顺序模式
            priority: 10,
            condition: { selfHealth: { below: 50 } },
            action: {
                mode: "sequence",
                sequence: [
                    "rage_buff",      // 第1次：狂暴
                    "ultimate_attack", // 第2次：大招
                    "ultimate_attack"  // 第3次：大招
                ]
            },
            describe: "第二阶段：狂暴输出"
        }
    ]
}

// 配合敌人属性
{
    status: {
        "actions-per-turn": 2  // 每回合2次行动
    },
    behavior: advancedBossBehavior
}
```

## 注意事项

1. **条件是 AND 关系**：一个 `condition` 中的所有条件都要满足
2. **优先级很重要**：濒死反击等关键行为应该设置高优先级
3. **总是提供 fallback**：避免没有可用行为的情况
4. **序列模式需要维护状态**：`sequenceIndex` 会自动递增
5. **权重可以是小数**：`weights: { "card1": 1.5, "card2": 0.5 }`
6. **自定义条件很灵活**：可以实现任何复杂逻辑
7. **每回合只触发一个 pattern**：第一个满足条件的 pattern 会被使用
8. **不同回合可以使用不同模式**：通过条件控制在不同情况下使用不同的行动模式
9. **多次行动需要配置属性**：`actions-per-turn` 属性控制每回合行动次数

## 扩展性

### 添加新的条件类型

如果需要新的条件类型，可以在 `BehaviorCondition` 中添加：

```typescript
export type BehaviorCondition = {
    // ... 现有条件

    // 新条件：卡组剩余卡牌数
    deckSize?: {
        below?: number
        above?: number
    }
}
```

然后在 `evaluateCondition()` 中实现判断逻辑。

### 添加新的行动模式

如果需要新的行动模式，可以在 `ActionMode` 中添加：

```typescript
export type ActionMode =
    | "random"
    | "weighted"
    | "sequence"
    | "loop"
    | "adaptive"  // 新模式：自适应
```

然后在 `selectActionCards()` 中实现选择逻辑。

## 相关文件

- `EnemyBehavior.ts` - 行为配置系统实现
- `CardSelector.ts` - 卡牌筛选器
- `Enemy.ts` - 敌人类
- `Intent.ts` - 意图系统
