# 敌人系统完成总结

本文档总结敌人系统的完整实现。

## 已完成的模块

### ✅ 模块1：卡牌Tag与筛选器系统
- **CardSelector** - 通用卡牌筛选工具
- **cardTagMap** - 卡牌标签映射
- **Card.tags** - 卡牌标签属性

### ✅ 模块2：意图系统
- **Intent.ts** - 意图类型定义和转换函数
- **cardsToIntent()** - 将卡牌转换为意图
- **事件模拟系统** - 计算Buff影响后的最终值

### ✅ 模块3：敌人行为配置系统
- **EnemyBehavior.ts** - 完整的行为配置系统
- **BehaviorCondition** - 条件判断（血量、回合数、状态等）
- **ActionMode** - 行动模式（random、weighted、sequence、loop）
- **敌人行为.md** - 详细文档

### ✅ 模块4：敌人行动执行
- **Enemy.executeIntent()** - 执行意图中的卡牌
- **enemyTurn.ts** - 敌人回合管理
- **战斗流程集成** - 完整的回合切换

### ✅ 模块5：敌人示例数据
- **5个示例敌人** - 展示不同行为模式
- **完整配置** - 包含行为、器官、属性

### ✅ 额外完成：死亡状态系统重构
- **可配置的死亡行为** - 通过触发器系统
- **假死机制** - 支持复杂的死亡/复活逻辑
- **完整文档** - 死亡状态系统.md 和 假死敌人示例.md

## 核心特性

### 1. 意图系统
敌人的行动对玩家可见，显示：
- 意图类型（攻击/防御/增益/减益/特殊）
- 意图值（伤害/格挡数值）
- 攻击次数（多段攻击）
- **最终值**（包含Buff影响）

### 2. 行为配置系统
完全数据驱动的敌人AI：
- **条件判断**：血量、回合数、状态层数、自定义函数
- **行动模式**：随机、权重、顺序、循环
- **优先级系统**：多个条件同时满足时的处理
- **默认行为**：兜底机制

### 3. 灵活的战斗流程
- 玩家回合 → 敌人回合 → 循环
- 意图提前准备（玩家可以看到敌人下回合要做什么）
- 意图可以动态改变（通过 `enemy.updateIntent()`）
- 多次行动支持（`actions-per-turn` 属性）
- 行动顺序可配置（`action-order` 属性）

### 4. 死亡状态系统
- **isAlive** 独立状态（不等于 health > 0）
- **可配置的死亡行为**（通过 `onlyKey` 覆盖默认触发器）
- **多层防护**：
  - 覆盖 `healthReachMin` 触发器（改变死亡条件）
  - 拦截 `kill` 事件（阻止死亡）
  - `revive` 事件（死后复活）

## 示例敌人

### 1. 史莱姆 - 简单随机攻击
```typescript
{
    label:"史莱姆",
    key:"test_enemy_slime",
    status:{ "max-health":40 },
    behavior: {
        patterns: [],
        fallback: {
            action: {
                selector: { tags: ["attack"] },
                mode: "random"
            }
        }
    }
}
```

### 2. 狂战士 - 血量越低攻击越猛
```typescript
{
    label:"狂战士",
    key:"test_enemy_berserker",
    behavior: {
        patterns: [
            {
                priority: 10,
                condition: { selfHealth: { below: 30 } },
                action: {
                    selector: { tags: ["attack"] },
                    mode: "weighted",
                    weights: { "original_card_00002": 5 }
                },
                describe: "血量<30%：狂暴攻击"
            },
            {
                priority: 5,
                condition: { turn: { equals: 1 } },
                action: {
                    selector: { tags: ["power"] },
                    mode: "random"
                },
                describe: "第1回合：强化"
            }
        ],
        fallback: { /* 默认攻击 */ }
    }
}
```

### 3. 法师 - 循环攻击和强化
```typescript
{
    label:"法师",
    key:"test_enemy_mage",
    behavior: {
        patterns: [{
            action: {
                selector: {},
                mode: "loop",
                sequence: [
                    "original_card_00001",  // 打击
                    "original_card_00004"   // 肌肉强化
                ]
            },
            describe: "循环：攻击和强化交替"
        }]
    }
}
```

### 4. 双头蛇 - 多次行动
```typescript
{
    label:"双头蛇",
    key:"test_enemy_elite",
    status:{
        "max-health":80,
        "actions-per-turn": 2  // 每回合行动2次
    },
    behavior: {
        patterns: [{
            priority: 10,
            condition: { turn: { mod: [3, 0] } },
            action: {
                selector: { tags: ["power"] },
                mode: "random"
            },
            describe: "每3回合：强化"
        }],
        fallback: { /* 默认攻击 */ }
    }
}
```

### 5. 守护者 - 多阶段Boss
```typescript
{
    label:"守护者",
    key:"test_enemy_boss",
    status:{ "max-health":150 },
    behavior: {
        patterns: [
            {
                priority: 10,
                condition: { selfHealth: { above: 66 } },
                action: { /* 第一阶段：蓄力 */ },
                describe: "第一阶段：蓄力"
            },
            {
                priority: 10,
                condition: { selfHealth: { above: 33 } },
                action: { /* 第二阶段：猛攻 */ },
                describe: "第二阶段：猛攻"
            },
            {
                priority: 10,
                condition: { selfHealth: { below: 33 } },
                action: { /* 第三阶段：狂暴 */ },
                describe: "第三阶段：狂暴"
            }
        ]
    }
}
```

## 关键文件

### 核心系统
- `Intent.ts` - 意图系统
- `EnemyBehavior.ts` - 行为配置系统
- `CardSelector.ts` - 卡牌筛选器
- `Enemy.ts` - 敌人类
- `enemyTurn.ts` - 敌人回合管理
- `battle.ts` - 战斗流程

### 死亡系统
- `isAlive.ts` - isAlive 当前值
- `health.ts` - 生命值配置
- `lifeControl.ts` - kill 和 revive 效果
- `Target.ts` - Chara 类（默认死亡触发器）

### 数据
- `enemyList.ts` - 敌人数据
- `cardTagMap.ts` - 卡牌标签映射
- `effectMap.ts` - 效果映射

### 文档
- `敌人行为.md` - 行为配置系统文档
- `战斗流程.md` - 战斗流程文档
- `死亡状态系统.md` - 死亡系统文档
- `假死敌人示例.md` - 假死机制示例
- `卡牌Tag与筛选器.md` - 筛选器文档
- `词条Entry.md` - 词条系统文档

## 使用示例

### 创建战斗
```typescript
import { startNewBattle } from "@/core/objects/game/battle"
import { getEnemyByKey } from "@/static/list/target/enemyList"
import { nowPlayer } from "@/core/objects/game/run"

// 创建敌人
const slime = getEnemyByKey("test_enemy_slime")
const berserker = getEnemyByKey("test_enemy_berserker")

// 开始战斗
await startNewBattle(
    [nowPlayer],           // 玩家队伍
    [slime, berserker]     // 敌人队伍
)
```

### 结束玩家回合
```typescript
import { nowBattle } from "@/core/objects/game/battle"

// 玩家点击"结束回合"按钮
if (nowBattle.value) {
    await nowBattle.value.endPlayerTurnAndStartEnemyTurn()
}
```

### 动态改变敌人意图
```typescript
// 在某个效果或触发器中
enemy.updateIntent(player, battle.turnNumber)
```

### 创建假死敌人
```typescript
{
    key: "enemy_fake_death",
    label: "不死守卫",
    trigger: [{
        when: "after",
        how: "take",
        key: "healthReachMin",
        onlyKey: "default_death_on_health_zero",  // 覆盖默认死亡
        event: [{
            targetType: "self",
            key: "enterFakeDeath",
            effect: [{
                key: "applyState",
                params: { stateKey: "fake_death", stacks: 1 }
            }]
        }]
    }]
}
```

## 待完成

### UI组件
- [ ] 敌人显示组件
- [ ] 意图显示组件
- [ ] 血条和状态显示
- [ ] 死亡动画

### 测试
- [ ] 完整战斗流程测试
- [ ] 各种行为模式测试
- [ ] 意图显示测试
- [ ] 死亡/复活测试

## 扩展性

### 添加新的条件类型
在 `BehaviorCondition` 中添加新字段，然后在 `evaluateCondition()` 中实现判断逻辑。

### 添加新的行动模式
在 `ActionMode` 中添加新类型，然后在 `selectActionCards()` 中实现选择逻辑。

### 添加新的意图类型
在 `IntentType` 中添加新类型，然后在 `cardsToIntent()` 中实现判断逻辑。

### 创建复杂的死亡机制
通过覆盖 `healthReachMin` 触发器，可以实现：
- 假死
- 多次复活
- 条件死亡
- 延迟死亡
- 死亡时触发特殊效果

## 总结

敌人系统现在已经完全实现，具有以下特点：

1. **完全数据驱动** - 所有行为都可以通过数据配置
2. **高度灵活** - 支持各种复杂的行为模式
3. **可扩展** - 易于添加新的条件、模式、意图类型
4. **可预测** - 玩家可以看到敌人的意图
5. **可干预** - 死亡等关键流程可以被完全自定义

系统已经准备好进行UI集成和完整测试！
