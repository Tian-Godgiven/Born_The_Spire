# 战斗流程

本文档描述完整的战斗流程，包括玩家回合、敌人回合、意图系统和战斗结束判定。

## 核心流程图

```
战斗开始 (startNewBattle)
  ↓
触发 battleStart 事件
  ↓
准备敌人意图（第1回合）
  ↓
玩家回合开始 (turnStart 事件)
  ↓
┌─→ 玩家行动（打牌、使用药水等）
│     ↓
│   玩家点击"结束回合"按钮
│     ↓
│   调用 battle.endPlayerTurnAndStartEnemyTurn()
│     ↓
│   玩家回合结束 (turnEnd 事件)
│     ↓
│   检查玩家是否死亡 → 是 → 战斗失败
│     ↓ 否
│   敌人回合开始
│     ↓
│   按 action-order 排序敌人
│     ↓
│   依次执行每个敌人的行动
│     ↓
│   检查战斗是否结束 → 是 → 战斗结束
│     ↓ 否
│   turnNumber++
│     ↓
│   准备下回合敌人意图
│     ↓
│   玩家回合开始 (turnStart 事件)
│     ↓
└─────┘
```

## 详细流程

### 1. 战斗开始 (startNewBattle)

**文件**: `battle.ts`

```typescript
startNewBattle(playerTeam, enemyTeam)
```

**步骤**:
1. 创建 Battle 实例，初始 turnNumber = 1
2. 触发 `battleStart` 事件
3. 准备敌人意图（第1回合）
4. 开始玩家回合

**关键点**:
- 敌人意图在战斗开始时就准备好，让玩家看到敌人第一回合要做什么
- 意图准备会记录日志："准备敌人意图"

### 2. 玩家回合

**开始**: `battle.startTurn("player")`

**触发事件**: `turnStart`
- source/medium/target: player
- info: { turn: turnNumber }

**玩家行动**:
- 打出卡牌
- 使用药水
- 查看敌人意图
- 点击"结束回合"按钮

**结束**: 玩家点击"结束回合" → 调用 `battle.endPlayerTurnAndStartEnemyTurn()`

### 3. 玩家回合结束与敌人回合

**文件**: `battle.ts` - `endPlayerTurnAndStartEnemyTurn()`

**步骤**:

#### 3.1 结束玩家回合
```typescript
await battle.endTurn("player")
```
- 触发 `turnEnd` 事件
- 清除格挡（通过 turnEnd 触发器）
- 弃牌（通过 turnEnd 触发器）

#### 3.2 检查玩家是否死亡
```typescript
const battleResult = battle.checkBattleEnd()
if (battleResult === "player_lose") {
    battle.endBattle("player_lose")
    return
}
```

#### 3.3 敌人回合
```typescript
const aliveEnemies = battle.getAliveEnemies()
const sortedEnemies = battle.sortEnemiesByActionOrder(aliveEnemies)
await executeAllEnemiesTurn(sortedEnemies, player, turnNumber)
```

**敌人行动顺序**:
- 按 `status["action-order"]` 属性排序
- 数字小的先行动（默认为 0）
- 相同顺序按数组顺序

**每个敌人的回合** (`executeEnemyTurn`):
1. 选择行动（根据行为配置）
2. 设置意图（用于显示，但本回合执行的是上回合设置的意图）
3. 执行意图中的卡牌
4. 检查敌人是否死亡

**多次行动**:
- 如果敌人有 `status["actions-per-turn"]` 属性
- 会在同一回合内执行多次行动
- 每次行动都会重新选择卡牌

#### 3.4 检查战斗是否结束
```typescript
const afterEnemyResult = battle.checkBattleEnd()
if (afterEnemyResult) {
    battle.endBattle(afterEnemyResult)
    return
}
```

#### 3.5 回合数递增
```typescript
battle.turnNumber++
```

#### 3.6 准备下回合敌人意图
```typescript
prepareEnemyIntents(aliveEnemies, player, turnNumber)
```
- 每个敌人根据行为配置选择下回合的行动
- 设置意图，供玩家查看
- 记录日志："敌人设置意图"

#### 3.7 开始新的玩家回合
```typescript
await battle.startTurn("player")
```

## 意图系统

### 意图准备时机

1. **战斗开始时**: 准备第1回合的意图
2. **每个敌人回合结束后**: 准备下回合的意图

### 意图更新接口

**方法**: `enemy.updateIntent(player, turnCount)`

**用途**: 允许效果/状态动态改变敌人意图

**示例场景**:
- 形态转换：Boss 进入第二阶段，改变行为模式
- 反应式行为：受到大量伤害后改变策略（需要通过触发器调用）

**调用方式**:
```typescript
// 在某个效果或触发器中
enemy.updateIntent(player, battle.turnNumber)
```

**效果**:
- 重新根据行为配置选择行动
- 更新意图
- 记录日志："敌人改变意图"
- UI 应该显示动画（意图渐隐 → 新意图渐显）

### 意图显示

**显示内容**:
- 意图类型（攻击/防御/增益/减益/特殊）
- 意图值（伤害/格挡数值）
- 攻击次数（多段攻击）

**显示值**:
- **必须是最终值**（包含 Buff 影响）
- 使用事件模拟系统计算
- 例如：敌人有 3 层力量，打出 10 伤害的卡牌，显示 13 伤害

**可见性等级**:
- `hidden`: 完全隐藏
- `type`: 只显示类型（攻击/防御等）
- `range`: 显示范围（5-10 伤害）
- `exact`: 显示精确值（默认）

## 战斗结束

### 结束条件

**玩家失败**: 所有玩家角色死亡（HP ≤ 0）
**玩家胜利**: 所有敌人死亡（HP ≤ 0）

### 检查时机

1. **玩家回合结束后**: 检查玩家是否死亡
2. **敌人回合结束后**: 检查是否所有敌人死亡

### 结束流程

**文件**: `battle.ts` - `endBattle(result)`

```typescript
battle.endBattle("player_win" | "player_lose")
```

**步骤**:
1. 设置 `battle.isEnded = true`
2. 记录日志："战斗胜利" 或 "战斗失败"
3. 触发 `battleEnd` 事件
   - info: { result: "win" | "lose" }
4. TODO: 触发战斗结束的 UI 和逻辑

## 敌人行动顺序

### 配置方式

在敌人数据中添加 `action-order` 属性：

```typescript
{
    key: "enemy_001",
    label: "史莱姆",
    status: {
        maxHealth: 50,
        "action-order": 0  // 数字小的先行动
    }
}
```

### 排序规则

1. 按 `action-order` 数值升序排序
2. 未设置的默认为 0
3. 相同数值按数组顺序

### 示例

```typescript
// 敌人列表
[
    { label: "Boss", action-order: 10 },      // 最后行动
    { label: "小怪A", action-order: 1 },      // 第一个行动
    { label: "小怪B", action-order: 1 },      // 第二个行动（相同顺序）
    { label: "精英", action-order: 5 }        // 第三个行动
]

// 实际行动顺序：小怪A → 小怪B → 精英 → Boss
```

## 回合数定义

**turnNumber**: 战斗开始后的总回合数

- 战斗开始时 = 1
- 每个完整回合（玩家回合 + 敌人回合）结束后 +1
- 用于行为配置的条件判断（如"第3回合使用大招"）

**时间线**:
```
turnNumber = 1: 玩家回合1 → 敌人回合1
turnNumber = 2: 玩家回合2 → 敌人回合2
turnNumber = 3: 玩家回合3 → 敌人回合3
...
```

## 关键 API

### Battle 类

```typescript
class Battle {
    turnNumber: number              // 当前回合数
    isEnded: boolean                // 战斗是否已结束

    getAliveEnemies(): Enemy[]      // 获取存活的敌人
    getAlivePlayers(): Player[]     // 获取存活的玩家
    checkBattleEnd(): "player_win" | "player_lose" | null  // 检查战斗是否结束

    async startTurn(team: "player" | "enemy")  // 开始某方回合
    async endTurn(team: "player" | "enemy")    // 结束某方回合

    async endPlayerTurnAndStartEnemyTurn()     // 结束玩家回合，开始敌人回合
}
```

### 敌人回合函数

```typescript
// 执行单个敌人的回合
async function executeEnemyTurn(
    enemy: Enemy,
    player: Player,
    turnCount: number
)

// 执行所有敌人的回合
async function executeAllEnemiesTurn(
    enemies: Enemy[],
    player: Player,
    turnCount: number
)

// 准备敌人意图
function prepareEnemyIntents(
    enemies: Enemy[],
    player: Player,
    turnCount: number
)
```

### Enemy 类

```typescript
class Enemy {
    intent?: Intent  // 当前意图

    setIntent(cards: Card[], visibility?: IntentVisibility)  // 设置意图
    updateIntent(player: Player, turnCount: number)          // 更新意图
    clearIntent()                                             // 清除意图
    getIntent(): Intent | undefined                           // 获取意图

    async executeIntent(target: Player)  // 执行意图中的卡牌
}
```

## 日志记录

战斗流程中的关键日志：

```
[战斗开始]
准备敌人意图, 回合 1
敌人设置意图, 史莱姆, {...}

===== 玩家回合开始 =====, 回合 1
[玩家行动...]

===== 玩家回合结束 =====
===== 敌人回合开始 =====
敌人使用卡牌, 史莱姆, 打击
===== 敌人回合结束 =====, 史莱姆

准备敌人意图, 回合 2
敌人设置意图, 史莱姆, {...}

===== 玩家回合开始 =====, 回合 2
...
```

## UI 集成要点

### 结束回合按钮

```typescript
// 在 UI 中
<button @click="endPlayerTurn">结束回合</button>

function endPlayerTurn() {
    if (nowBattle.value) {
        nowBattle.value.endPlayerTurnAndStartEnemyTurn()
    }
}
```

### 意图显示

- 在敌人 UI 组件中显示 `enemy.intent`
- 当意图改变时，播放渐隐/渐显动画
- 显示意图类型图标和数值

### 战斗结束

- 监听 `battle.isEnded` 状态
- 显示胜利/失败界面
- 提供"继续"或"重试"按钮

## 注意事项

1. **异步执行**: 所有回合相关函数都是 async，确保事件按顺序执行
2. **死亡检查**: 在关键节点检查战斗是否结束，避免死亡后继续执行
3. **意图时机**: 意图是为**下回合**准备的，当前回合执行的是上回合设置的意图
4. **事件模拟**: 意图显示的值必须通过事件模拟计算，确保包含 Buff 影响
5. **日志记录**: 所有关键操作都应记录日志，方便调试和玩家理解

## 相关文件

- `battle.ts` - 战斗类和战斗管理
- `enemyTurn.ts` - 敌人回合逻辑
- `turn.ts` - 回合开始/结束处理
- `Enemy.ts` - 敌人类
- `Intent.ts` - 意图系统
- `EnemyBehavior.ts` - 敌人行为配置
