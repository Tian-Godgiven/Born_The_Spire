# äº‹ä»¶æˆ¿é—´ (Event Room)

äº‹ä»¶æ˜¯æˆ¿é—´çš„ä¸€ç§ï¼Œæä¾›å¤šç§é€‰é¡¹å’Œéšæœºäº‹ä»¶çš„åœºæ‰€ã€‚

## åŸºæœ¬ä¿¡æ¯

åœ¨å±‚çº§å†…ï¼Œæ¦‚ç‡å‡ºç°çš„ç‰¹æ®Šæˆ¿é—´ï¼Œæ¯å±‚çš„æ•°é‡ä¸º3~7ä¸ªã€‚å…¶ä¸­å‘ç”Ÿçš„äº‹ä»¶ä¼šä»å½“å‰å±‚çš„äº‹ä»¶æ± ä¸­æŠ½å–ï¼Œä¸ä¼šé‡å¤ã€‚

äº‹ä»¶å…·å¤‡ä¸åŒçš„é€‰é¡¹ï¼Œå¯¹åº”äº§ç”Ÿä¸åŒçš„æ•ˆæœï¼Œå¯èƒ½å…·å¤‡éšæœºæ€§ï¼Œè¿™äº›æ•ˆæœéƒ½ä¼šæ˜¾ç¤ºåœ¨é€‰é¡¹ä¸Šï¼Œä¸ä¼šå‡ºç°çº¯ç²¹çš„æƒ©ç½šæ€§äº‹ä»¶ã€‚äº‹ä»¶èƒ½å¤Ÿæä¾›çš„æ•ˆæœå¤šç§å¤šæ ·ã€‚

å…è®¸ç©å®¶é€šè¿‡SLçš„æ–¹å¼é‡ç½®äº‹ä»¶ï¼Œä½†éšæœºçš„ç»“æœå¹¶ä¸ä¼šæ”¹å˜ã€‚

## äº‹ä»¶ç³»ç»Ÿæ¶æ„

äº‹ä»¶æˆ¿é—´ç”±ä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†ç»„æˆï¼š

1. **äº‹ä»¶é…ç½® (EventMap)**ï¼šå®šä¹‰äº‹ä»¶çš„æ ‡é¢˜ã€æè¿°ã€å›¾æ ‡å’Œé€‰é¡¹åˆ—è¡¨
2. **äº‹ä»¶æ•ˆæœæ˜ å°„ (eventEffectMap)**ï¼šå°†æ•ˆæœ key æ˜ å°„åˆ°å…·ä½“çš„æ•ˆæœå‡½æ•°
3. **äº‹ä»¶æˆ¿é—´ç±» (EventRoom)**ï¼šç®¡ç†äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸå’Œé€‰é¡¹äº¤äº’

## äº‹ä»¶é…ç½®ç»“æ„

```typescript
interface EventMap {
    key: string                     // äº‹ä»¶å”¯ä¸€æ ‡è¯†
    title: string                   // äº‹ä»¶æ ‡é¢˜
    description: string             // äº‹ä»¶æè¿°
    icon?: string                   // äº‹ä»¶å›¾æ ‡
    options: EventOptionMap[]       // äº‹ä»¶é€‰é¡¹åˆ—è¡¨
    component?: Component | string  // è‡ªå®šä¹‰äº‹ä»¶ç»„ä»¶ï¼ˆå¯é€‰ï¼‰
}

interface EventOptionMap {
    title: string                   // é€‰é¡¹æ ‡é¢˜
    description: string             // é€‰é¡¹æè¿°
    icon?: string                   // é€‰é¡¹å›¾æ ‡
    effects?: Array<{               // ç®€å•æ•ˆæœåˆ—è¡¨
        key: string                 // æ•ˆæœ keyï¼ˆå¯¹åº” eventEffectMapï¼‰
        params?: any                // æ•ˆæœå‚æ•°
    }>
    component?: Component | string  // å¤æ‚äº¤äº’ç»„ä»¶ï¼ˆè½¬ç›˜ã€é…å¯¹ç­‰ï¼‰
    customCallback?: () => void | Promise<void>  // è‡ªå®šä¹‰å›è°ƒ
}
```

## äº‹ä»¶ç±»å‹

### 1. ç®€å•æ•ˆæœäº‹ä»¶

ä½¿ç”¨ `effects` æ•°ç»„å®šä¹‰ï¼Œæ¯ä¸ªæ•ˆæœé€šè¿‡ `eventEffectMap` æ‰§è¡Œ

```typescript
{
    key: "event_treasure_chest",
    title: "å®ç®±",
    description: "ä½ å‘ç°äº†ä¸€ä¸ªå®ç®±...",
    options: [
        {
            title: "æ‰“å¼€å®ç®±",
            description: "è·å¾—éšæœºå¥–åŠ±",
            effects: [
                { key: "gainMaterial", params: { amount: 100 } },
                { key: "gainRandomCard", params: { count: 1 } }
            ]
        }
    ]
}
```

### 2. å¤æ‚äº¤äº’äº‹ä»¶

ä½¿ç”¨ `component` æŒ‡å®šè‡ªå®šä¹‰ç»„ä»¶ï¼ˆå¦‚è½¬ç›˜ã€é…å¯¹æ¸¸æˆç­‰ï¼‰

```typescript
{
    key: "event_gambling",
    title: "èµŒåš",
    description: "ä¸€ä¸ªèµŒå¾’é‚€è¯·ä½ å‚ä¸ä¸€åœºæ¸¸æˆ...",
    options: [
        {
            title: "å‚ä¸èµŒåšï¼ˆèŠ±è´¹ 50 é‡‘é’±ï¼‰",
            description: "è½¬åŠ¨è½¬ç›˜ï¼Œè·å¾—éšæœºå¥–åŠ±",
            effects: [
                { key: "loseGold", params: { amount: 50 } }
            ],
            component: "RouletteWheel"  // è‡ªå®šä¹‰è½¬ç›˜ç»„ä»¶
        }
    ]
}
```

### 3. è‡ªå®šä¹‰å›è°ƒäº‹ä»¶

ä½¿ç”¨ `customCallback` æ‰§è¡Œå¤æ‚é€»è¾‘

```typescript
{
    title: "å‡çº§å™¨å®˜",
    description: "é€‰æ‹©ä¸€ä¸ªå™¨å®˜è¿›è¡Œå‡çº§",
    customCallback: async () => {
        // æ‰“å¼€å™¨å®˜å‡çº§ç•Œé¢
        await openOrganUpgradeUI()
    }
}
```

## äº‹ä»¶æ•ˆæœç³»ç»Ÿ

### å¯ç”¨æ•ˆæœåˆ—è¡¨

ä½ç½®ï¼š`src/static/list/room/event/eventEffectMap.ts`

å½“å‰å·²æ³¨å†Œçš„æ•ˆæœï¼š

| æ•ˆæœ Key | å‚æ•° | è¯´æ˜ | çŠ¶æ€ |
|---------|------|------|------|
| `nothing` | - | æ— æ•ˆæœ | âœ… |
| `gainMaterial` | `{ amount: number }` | è·å¾—ç‰©è´¨ | âš ï¸ TODO |
| `loseMaterial` | `{ amount: number }` | å¤±å»ç‰©è´¨ | âš ï¸ TODO |
| `gainGold` | `{ amount: number }` | è·å¾—é‡‘é’± | âš ï¸ TODO |
| `loseGold` | `{ amount: number }` | å¤±å»é‡‘é’± | âš ï¸ TODO |
| `healHealth` | `{ amount: number }` | å›å¤ç”Ÿå‘½ | âš ï¸ TODO |
| `loseHealth` | `{ amount: number }` | å¤±å»ç”Ÿå‘½ | âš ï¸ TODO |
| `gainMaxHealth` | `{ amount: number }` | å¢åŠ æœ€å¤§ç”Ÿå‘½ | âš ï¸ TODO |
| `gainRelic` | `{ relicKey: string }` | è·å¾—é—ç‰© | âš ï¸ TODO |
| `gainPotion` | `{ potionKey: string }` | è·å¾—è¯æ°´ | âš ï¸ TODO |
| `gainCard` | `{ cardKey: string }` | è·å¾—å¡ç‰Œ | âš ï¸ TODO |
| `removeCard` | `{ cardKey: string }` | ç§»é™¤å¡ç‰Œ | âš ï¸ TODO |
| `upgradeCard` | `{ cardKey: string }` | å‡çº§å¡ç‰Œ | âš ï¸ TODO |
| `gainOrgan` | `{ organKey: string }` | è·å¾—å™¨å®˜ | âš ï¸ TODO |
| `removeOrgan` | `{ organKey: string }` | ç§»é™¤å™¨å®˜ | âš ï¸ TODO |
| `gainRandomRelic` | `{ count: number }` | è·å¾—éšæœºé—ç‰© | âš ï¸ TODO |
| `gainRandomPotion` | `{ count: number }` | è·å¾—éšæœºè¯æ°´ | âš ï¸ TODO |
| `gainRandomCard` | `{ count: number }` | è·å¾—éšæœºå¡ç‰Œ | âš ï¸ TODO |
| `gainRandomReward` | `{ type: string }` | è·å¾—éšæœºå¥–åŠ± | âš ï¸ TODO |

### æ·»åŠ æ–°æ•ˆæœ

åœ¨ `eventEffectMap.ts` ä¸­æ·»åŠ ï¼š

```typescript
import { nowPlayer } from "@/core/hooks/player"

export const eventEffectMap = {
    // å·²æœ‰æ•ˆæœ...

    // æ–°å¢æ•ˆæœ
    myNewEffect: async (params: { value: number }) => {
        // å®ç°æ•ˆæœé€»è¾‘
        nowPlayer.someMethod(params.value)
    }
}
```

## äº‹ä»¶æˆ¿é—´ç”Ÿå‘½å‘¨æœŸ

```typescript
// 1. è¿›å…¥æˆ¿é—´
await eventRoom.enter()
// æ˜¾ç¤ºäº‹ä»¶æ ‡é¢˜å’Œæè¿°ï¼Œè®°å½•æ—¥å¿—

// 2. å¤„ç†æˆ¿é—´ï¼ˆUI é©±åŠ¨ï¼‰
await eventRoom.process()
// ç©å®¶é€šè¿‡ UI é€‰æ‹©é€‰é¡¹

// 3. é€‰é¡¹è¢«é€‰æ‹©
await eventRoom.onOptionSelected(option)
// æ‰§è¡Œ effectsã€customCallbackã€æˆ–æ‰“å¼€ component

// 4. å®Œæˆæˆ¿é—´
await eventRoom.complete()
// è®°å½•ç»“æŸæ—¥å¿—

// 5. ç¦»å¼€æˆ¿é—´
await eventRoom.exit()
// æ¸…ç†çŠ¶æ€
```

## å¯é…ç½®é¡¹

```typescript
interface EventRoomConfig extends RoomConfig {
    type: "event"
    eventConfig?: EventMap          // ç›´æ¥æä¾›äº‹ä»¶é…ç½®
    eventKey?: string               // ä» eventList åŠ è½½äº‹ä»¶
    customData?: {
        eventKey?: string           // ä» roomList åˆ›å»ºæ—¶ä½¿ç”¨
    }
}
```

## ç›¸å…³æ–‡ä»¶

é€»è¾‘ï¼š`src/core/objects/room/EventRoom.ts`
UIï¼š`src/ui/page/Scene/running/EventRoom.vue`
äº‹ä»¶é…ç½®ï¼š`src/static/list/room/event/eventList.ts`
æ•ˆæœæ˜ å°„ï¼š`src/static/list/room/event/eventEffectMap.ts`
é€‰é¡¹ç³»ç»Ÿï¼š`src/core/objects/system/Choice.ts`

## æ³¨æ„äº‹é¡¹

1. **é€‰é¡¹å¿…é¡»æœ‰å‡ºå£**ï¼šâš ï¸ äº‹ä»¶çš„é€‰é¡¹/é€‰é¡¹æ ‘æœ€åå¿…é¡»å¯¼å‘ä¸€ä¸ª"ç¦»å¼€"é€‰é¡¹ï¼Œä¸è¦è®©ç©å®¶å›°åœ¨äº‹ä»¶å†…æ— æ³•é€€å‡ºã€‚å³ä½¿æ˜¯å¤šå±‚é€‰é¡¹æ ‘ï¼Œä¹Ÿè¦ç¡®ä¿æ¯æ¡è·¯å¾„æœ€ç»ˆéƒ½èƒ½ç¦»å¼€äº‹ä»¶æˆ¿é—´
2. **æ•ˆæœæ‰§è¡Œé¡ºåº**ï¼š`effects` æ•°ç»„ä¸­çš„æ•ˆæœæŒ‰é¡ºåºæ‰§è¡Œï¼Œåç»­æ•ˆæœå¯èƒ½ä¾èµ–å‰é¢æ•ˆæœçš„ç»“æœ
3. **äº‹ä»¶å”¯ä¸€æ€§**ï¼šäº‹ä»¶ä»æ± ä¸­æŠ½å–åä¸ä¼šé‡å¤å‡ºç°ï¼ˆé™¤éé‡ç½®äº‹ä»¶æ± ï¼‰
4. **SL æœºåˆ¶**ï¼šç©å®¶å¯ä»¥é‡ç½®äº‹ä»¶ï¼Œä½†éšæœºç»“æœæ˜¯å›ºå®šçš„ï¼ˆå…¨å±€éšæœºç§å­ç³»ç»Ÿå°šæœªå®ç°ï¼Œè§ä»»åŠ¡åˆ—è¡¨ï¼‰
5. **é€‰é¡¹ç»„å“åº”å¼**ï¼š`ChoiceGroup.choices` æ˜¯å“åº”å¼æ•°ç»„ï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ /ç§»é™¤é€‰é¡¹
6. **è‡ªå®šä¹‰ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ**ï¼šè‡ªå®šä¹‰ç»„ä»¶éœ€è¦è‡ªè¡Œç®¡ç†ä¸äº‹ä»¶æˆ¿é—´çš„äº¤äº’
7. **æ•ˆæœå¾…å®Œæˆ**ï¼šå¤§éƒ¨ï¿½ï¿½ï¿½äº‹ä»¶æ•ˆæœå°šæœªå®ç°ï¼ˆæ ‡è®°ä¸º TODOï¼‰ï¼Œéœ€è¦ä¼˜å…ˆå®Œæˆ

## äº‹ä»¶æˆ¿é—´æ³¨å†Œ

ä½ç½®ï¼š`src/static/registry/rooms/initEventRooms.ts`

### ç±»å‹æ³¨å†Œ

```typescript
import { EventRoom } from "@/core/objects/room/EventRoom"
import { roomRegistry } from "../roomRegistry"

roomRegistry.registerRoomType("event", EventRoom)
```

### é…ç½®æ³¨å†Œ

äº‹ä»¶é…ç½®ä» `eventList` æ‡’åŠ è½½æ¨¡å—æ‰¹é‡æ³¨å†Œï¼š

```typescript
import { getLazyModule } from "@/core/utils/lazyLoader"

const eventList = getLazyModule<EventMap[]>('eventList')

eventList.forEach(event => {
    roomRegistry.registerRoomConfig({
        key: event.key,
        type: "event",
        name: event.title,
        description: event.description,
        customData: {
            eventKey: event.key
        }
    })
})
```

### æ·»åŠ æ–°äº‹ä»¶

åœ¨ `eventList.ts` ä¸­æ·»åŠ ï¼š

```typescript
export const eventList: EventMap[] = [
    // å·²æœ‰äº‹ä»¶...

    // æ–°äº‹ä»¶
    {
        key: "event_new",
        title: "æ–°äº‹ä»¶",
        description: "è¿™æ˜¯ä¸€ä¸ªæ–°äº‹ä»¶",
        icon: "ğŸ²",
        options: [
            {
                title: "é€‰é¡¹1",
                description: "é€‰æ‹©è¿™ä¸ªé€‰é¡¹",
                effects: [
                    { key: "gainMaterial", params: { amount: 50 } }
                ]
            },
            {
                title: "é€‰é¡¹2",
                description: "é€‰æ‹©å¦ä¸€ä¸ªé€‰é¡¹",
                effects: [
                    { key: "healHealth", params: { amount: 20 } }
                ]
            },
            {
                title: "ç¦»å¼€",
                description: "ä»€ä¹ˆä¹Ÿä¸åš",
                effects: [
                    { key: "nothing" }
                ]
            }
        ]
    }
]
```

é…ç½®ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œåˆ°æˆ¿é—´æ³¨å†Œè¡¨