# 战斗房间 (Battle Room)

战斗是房间的一种，玩家与敌人进行回合制战斗的场所。

## 基本信息

在层级内随机遭遇的房间，战斗房间由 BattleRoom 类包装 Battle 系统进行管理。战斗为回合制，以玩家回合为起始，持续到一方的生命归0。

打败敌人即可移动到下一层。
打败Boss敌人将会移动到下一层级。(见房间/层级系统)

战斗分为三种类型：普通战斗、精英战斗、Boss战斗。
不同类型的战斗有不同的敌人配置和奖励。

### 普通战斗 (Normal)

敌人配置：从战斗配置中加载的普通敌人
出现规则：在层级内随机遭遇
战斗奖励：
  吞噬物质：获得基础物质（计算公式：30 + 层级 × 5）
  同化器官：从敌人拥有的所有器官中随机抽取3个，选择其中1个进行同化，也可以选择吞噬器官获得额外物质
实现：`BattleRoom.handleNormalRewards()` 计算物质并通过 `ReserveModifier.gainReserve()` 给予奖励

### 精英战斗 (Elite)

敌人配置：从战斗配置中加载的精英敌人
出现规则：在层级内低概率遭遇
战斗奖励：
  吞噬物质：与普通战斗相同
  同化器官：随机3选1（与普通战斗相同）
  遗物奖励：额外从遗物池中随机抽取1个不重复的遗物
实现：`BattleRoom.handleEliteRewards()` 先调用普通奖励，再添加遗物奖励

### Boss战斗 (Boss)

敌人配置：从战斗配置中加载的Boss敌人
出现时机：每层的末尾固定出现
战斗奖励：
  吞噬物质：双倍物质（计算公式：(30 + 层级 × 5) × 2）
  Boss器官：从Boss身上的所有器官中选择1个进行同化，与普通同化器官选项互斥
  Boss遗物：从3个随机抽取的Boss级遗物中选择1个
实现：`BattleRoom.handleBossRewards()` 给予双倍物质，显示所有Boss器官和Boss遗物供选择

## 战斗流程生命周期

战斗房间的生命周期由以下方法管理：

进入房间 (enter)
  生成敌人实例
  记录日志

处理房间 (process)
  启动 Battle 系统
  Battle 系统接管战斗逻辑（回合流程、卡牌使用、敌人行动等）

完成房间 (complete)
  检查战斗结果（胜利/失败）
  战斗胜利时结算奖励
  战斗失败时触发失败逻辑

离开房间 (exit)
  清理战斗状态
  清空敌人列表
  记录日志

## 可配置项

战斗房间通过 BattleRoomConfig 接口配置：

```typescript
interface BattleRoomConfig extends RoomConfig {
    type: "battle"
    battleType?: BattleRoomType  // 战斗类型：normal, elite, boss
    enemyConfigs?: EnemyMap[] | string[]    // 敌人配置列表或敌人 key 列表
    customData?: {
        battleType?: BattleRoomType
        enemyConfigs?: string[]  // 敌人 key 列表
    }
}
```

配置说明：
  battleType：指定战斗类型，默认为 "normal"
  enemyConfigs：可以是完整的 EnemyMap 配置数组，也可以是敌人 key 字符串数组（从 enemyList 中加载）

## 相关文件

逻辑：src/core/objects/room/BattleRoom.ts
UI：src/ui/page/Scene/running/BattleRoom.vue
战斗系统：src/core/objects/game/battle.ts
战斗配置：src/static/list/room/battle/battleList.ts

## 注意事项

敌人配置加载：enemyConfigs 支持两种方式
  直接提供完整的 EnemyMap 配置数组
  提供敌人 key 字符串数组，BattleRoom 会从 enemyList 中查找对应配置

战斗失败逻辑：目前战斗失败的处理逻辑尚未实现

奖励选择UI：所有奖励选择界面（器官选择、遗物选择）尚未实现，目前仅在日志中显示

随机器官抽取：普通战斗和精英战斗的器官抽取使用 Math.random() 进行随机，未使用全局随机种子系统（该系统尚未实现）







# 高级

## 战斗房间注册

位置：`src/static/registry/rooms/initBattleRooms.ts`

战斗房间的注册包括类型注册和配置注册

### 类型注册

```typescript
import { BattleRoom } from "@/core/objects/room/BattleRoom"
import { roomRegistry } from "../roomRegistry"

roomRegistry.registerRoomType("battle", BattleRoom)
```

### 配置注册

战斗房间配置从 battleList 懒加载模块批量注册：

```typescript
import { getLazyModule } from "@/core/utils/lazyLoader"

const battleList = getLazyModule('battleList')

battleList.forEach(battle => {
    roomRegistry.registerRoomConfig({
        key: battle.key,
        type: "battle",
        name: battle.name,
        description: battle.description,
        customData: {
            battleType: battle.battleType,
            enemyConfigs: battle.enemyConfigs
        }
    })
})
```

### 添加新战斗

在 battleList.ts 中添加新的战斗配置：

```typescript
export const battleList = [
    // 已有战斗...

    // 新战斗
    {
        key: "battle_elite_new",
        name: "新精英战斗",
        description: "强大的新敌人",
        battleType: "elite",
        enemyConfigs: [
            { key: "enemy_new_elite", level: 5 }
        ]
    }
]
```

配置会在应用启动时自动注册到房间注册表