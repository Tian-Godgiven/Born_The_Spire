# 效果参数验证系统

效果参数验证系统用于在运行时验证 EffectUnit 的 params 是否符合预期，提供清晰的错误信息。

## 基本概念

效果参数验证系统会在创建 Effect 对象时自动验证参数：
  检查必需参数是否存在
  检查参数类型是否正确
  应用默认值
  规范化参数格式

## 自动验证

验证会在 `createEffectByUnit` 函数中自动执行，无需手动调用。

```typescript
// 在 ActionEvent 中使用 EffectUnit
doEvent({
  key: "damage",
  source: enemy,
  medium: card,
  target: player,
  effectUnits: [{
    key: "damage",
    params: { value: 10 }  // 参数会自动验证
  }]
})
```

如果参数验证失败，会：
  在控制台输出错误信息
  通过 newError 显示错误提示
  使用原始参数继续执行（避免游戏崩溃）

## 手动验证

如果需要手动验证参数（例如在创建卡牌数据时），可以使用：

```typescript
import { validateEffectParams, validateEffectParamsOrThrow } from "@/core/effects/validateEffectParams"

// 方式1：获取验证结果
const result = validateEffectParams("damage", { value: 10 })
if (result.valid) {
  console.log("参数正确:", result.params)
} else {
  console.error("参数错误:", result.errors)
}

// 方式2：验证失败时抛出错误
try {
  const params = validateEffectParamsOrThrow("damage", { value: 10 })
  // 使用验证后的参数
} catch (error) {
  // 处理验证失败
}
```

## 参数定义格式

每个效果的参数通过 schema 定义：

```typescript
{
  paramName: {
    type: "string" | "number" | "boolean" | "array" | "object" | "any",
    required: true,           // 是否必需（默认true）
    default: undefined,       // 默认值（如果提供，required自动为false）
    description: "参数说明",
    validate: (value) => true // 自定义验证函数（可选）
  }
}
```

## 已定义的效果参数

### 伤害相关

damage
  value (number): 伤害值

modifyDamageValue
  delta (number): 伤害修改量（正数增加，负数减少）

modifyDamageByPercent
  percent (number): 伤害修改百分比（1.0 = 100%）

### 治疗相关

heal
  value (number): 治疗值

### 状态相关

applyState
  stateKey (string): 状态key
  stacks (number | array): 层数（数字或Stack数组）

removeState
  stateKey (string): 状态key
  triggerRemoveEffect (boolean, 默认false): 是否触发移除效果

changeStateStack
  stateKey (string): 状态key
  stackKey (string, 默认"default"): 层数key
  delta (number): 层数变化量

### 属性相关

addStatusBaseValue
  statusKey (string): 属性key
  value (number): 基础值变化量

addStatusCurrentValue
  statusKey (string): 属性key
  value (number): 当前值变化量

addStatusBaseCurrentValue
  statusKey (string): 属性key（base层）
  currentKey (string): 当前值key
  value (number): 变化量

### 卡牌相关

drawCard
  value (number): 抽牌数量

discardCard
  pileName (string, 默认"handPile"): 弃牌来源牌堆
  count (number, 默认1): 弃牌数量

discardAllCard
  pileName (string, 默认"handPile"): 弃牌来源牌堆

exhaustCard
  pileName (string, 默认"handPile"): 消耗来源牌堆
  count (number, 默认1): 消耗数量

discoverCard
  count (number, 默认3): 展示卡牌数量
  selectCount (number | array, 默认1): 选择数量（数字或[min,max]）
  tags (array, 默认[]): 筛选标签
  allowDuplicate (boolean, 默认false): 是否允许重复

chooseRandomCard
  count (number): 展示卡牌数量
  selectCount (number | array, 默认1): 选择数量
  title (string, 默认"选择卡牌"): 标题
  description (string, 可选): 描述
  allowDuplicate (boolean, 默认false): 是否允许重复

chooseCardUpgrade
  count (number, 默认1): 可升级卡牌数量

chooseCardRemove
  count (number, 默认1): 可移除卡牌数量

chooseCardDuplicate
  count (number, 默认1): 可复制卡牌数量

customCardChoice
  cards (array): 卡牌key数组
  selectCount (number | array, 默认1): 选择数量
  title (string, 默认"选择卡牌"): 标题
  description (string, 可选): 描述
  cancelable (boolean, 默认false): 是否可取消

### 能量相关

gainEnergy
  value (number): 获得能量值

payEnergy
  value (number): 消耗能量值

### 回合相关

turnStart
  无参数

turnEnd
  无参数

### 生命相关

killTarget
  info (object, 可选): 死亡信息

reviveTarget
  healthPercent (number, 默认1.0): 复活时生命百分比

### 器官相关

replaceOrgan
  oldOrganKey (string): 旧器官key
  newOrganKey (string): 新器官key

### 修饰器相关

addStatusModifier
  statusKey (string): 属性key
  targetLayer (string, 默认"current"): 目标层（base/current）
  modifierType (string, 默认"additive"): 修饰器类型
  applyMode (string, 默认"absolute"): 应用模式
  modifierValue (number, 可选): 修饰器值
  modifierFunc (any, 可选): 修饰器函数
  clearable (boolean, 默认true): 是否可清除

addTriggerToTarget
  triggerConfig (object): 触发器配置

## 添加新效果的参数定义

在 `src/core/effects/validateEffectParams.ts` 中添加新效果的参数schema：

```typescript
const effectParamsSchemas: Record<string, EffectParamsSchema> = {
  // ... 现有定义 ...

  // 添加新效果
  myNewEffect: {
    requiredParam: {
      type: "number",
      description: "必需参数"
    },
    optionalParam: {
      type: "string",
      default: "默认值",
      description: "可选参数"
    }
  }
}
```

## 获取参数schema（用于文档生成）

```typescript
import { getEffectParamsSchema, getAllEffectParamsSchemas } from "@/core/effects/validateEffectParams"

// 获取单个效果的schema
const damageSchema = getEffectParamsSchema("damage")

// 获取所有效果的schema
const allSchemas = getAllEffectParamsSchemas()
```

## 注意事项

参数验证不会阻止效果执行
  验证失败时会记录错误，但仍使用原始参数继续执行
  这样可以避免因参数错误导致游戏崩溃

未定义schema的效果会跳过验证
  如果效果没有定义参数schema，会输出警告但不会报错
  建议为所有效果定义参数schema

类型转换仍然需要
  验证系统只检查类型，不会自动转换类型
  在效果函数中仍需要使用 Number()、String() 等进行类型转换

默认值会自动应用
  如果参数未提供且定义了默认值，会自动使用默认值
  这样可以简化卡牌数据的编写

## 相关文件

验证系统：src/core/effects/validateEffectParams.ts
集成位置：src/core/objects/system/effect/EffectUnit.ts
效果函数：src/core/effects/
