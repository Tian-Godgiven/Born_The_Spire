# 死亡状态系统

本文档描述角色的死亡和复活机制。

## 核心概念

### isAlive 当前值

所有角色（Player 和 Enemy）都有一个 `isAlive` 当前值：
- **1** = 存活
- **0** = 死亡

这是一个独立的状态，不直接等同于"生命值是否为0"。

### 可配置的死亡行为

**关键设计**：死亡行为不是硬编码的，而是通过触发器系统实现的。

- 默认行为：生命归0 → 立即死亡
- 可以覆盖：通过 `onlyKey` 机制替换默认触发器
- 完全灵活：可以实现假死、多次复活、条件死亡等

## 死亡流程

### 1. 生命值归零

当角色的生命值达到下限（0）时：

```typescript
// health.ts - reachMin 回调
reachMin: (event, owner) => {
    // 触发 healthReachMin 事件（不带效果）
    doEvent({
        key: "healthReachMin",
        source: event.source,
        medium: event.medium,
        target: owner,
        info: { reason: "生命值达到下限" },
        effectUnits: []
    })
}
```

**关键点**：`healthReachMin` 事件本身不做任何事，只是一个通知。

### 2. 默认死亡触发器

所有 `Chara` 对象在创建时会添加一个默认触发器：

```typescript
// Target.ts - Chara 构造函数
this.appendTrigger({
    when: "after",
    how: "take",
    key: "healthReachMin",
    onlyKey: "default_death_on_health_zero",  // 可以被覆盖
    importantKey: "death_behavior",
    callback: (event) => {
        // 默认行为：立即死亡
        doEvent({
            key: "kill",
            source: event.source,
            medium: event.medium,
            target: this,
            info: { reason: "生命值达到下限" },
            effectUnits: [{
                key: "kill",
                params: { reason: "生命值达到下限" }
            }]
        })
    }
})
```

**关键点**：
- 使用 `onlyKey: "default_death_on_health_zero"`
- 任何具有相同 `onlyKey` 的触发器都会覆盖这个默认行为
- 这允许完全自定义死亡逻辑

### 3. kill 事件

`kill` 事件会被触发，包含以下信息：
- **key**: "kill"
- **target**: 要杀死的目标
- **info.reason**: 死亡原因（用于日志）
- **effectUnits**: 包含 `kill` 效果

**关键点**：
- `kill` 事件可以被 **before 触发器拦截**
- 这允许实现"不死"、"濒死保护"等机制

### 4. kill 效果

`kill` 效果函数会执行：

```typescript
// lifeControl.ts - killTarget
export const killTarget: EffectFunc = (event, effect) => {
    const reason = effect.params.reason || "未知原因"

    // 检查是否已经死亡
    if (getCurrentValue(target, "isAlive", 1) === 0) {
        return  // 已经死亡，不重复处理
    }

    // 将 isAlive 设置为 0
    changeCurrentValue(target, "isAlive", 0, event)
}
```

### 5. isAlive 达到下限

当 `isAlive` 被设置为 0 时，触发 `reachMin` 回调：

```typescript
// isAlive.ts - reachMin 回调
reachMin: (event, owner) => {
    newLog(["角色死亡", owner.label])

    // 触发 death 事件（死亡后事件）
    doEvent({
        key: "death",
        source: event.source,
        medium: event.medium,
        target: owner,
        info: { reason: event.info?.reason || "未知原因" },
        effectUnits: []
    })
}
```

### 6. death 事件

`death` 事件在角色死亡后触发，用于：
- 死亡动画
- 掉落物品
- 触发"死亡时"效果
- 其他死亡后处理

## 覆盖默认死亡行为

### 示例1：假死敌人

"生命归0时进入假死状态，下回合复活并回复300生命"

```typescript
{
    key: "enemy_fake_death",
    label: "不死守卫",
    trigger: [
        {
            when: "after",
            how: "take",
            key: "healthReachMin",
            onlyKey: "default_death_on_health_zero",  // 覆盖默认触发器
            importantKey: "death_behavior",
            event: [{
                targetType: "self",
                key: "enterFakeDeath",
                effect: [{
                    key: "applyState",
                    params: {
                        stateKey: "fake_death",  // 添加假死状态
                        stacks: 1
                    }
                }]
            }]
        }
    ]
}
```

然后创建假死状态，在状态中处理复活：

```typescript
// 假死状态
{
    key: "fake_death",
    label: "假死",
    describe: ["下回合复活并回复300生命"],
    trigger: [{
        when: "after",
        how: "take",
        key: "turnStart",
        event: [{
            targetType: "stateOwner",
            key: "revive",
            effect: [
                {
                    key: "revive",
                    params: { healAmount: 300 }
                },
                {
                    key: "removeState",
                    params: { stateKey: "fake_death" }
                }
            ]
        }]
    }]
}
```

### 示例2：多次复活

"最多复活3次，每次复活回复100生命"

```typescript
{
    trigger: [{
        when: "after",
        how: "take",
        key: "healthReachMin",
        onlyKey: "default_death_on_health_zero",
        event: [{
            targetType: "self",
            key: "checkReviveCount",
            effect: [{
                key: "conditionalRevive",
                params: {
                    maxRevives: 3,
                    healAmount: 100
                }
            }]
        }]
    }]
}
```

### 示例3：条件死亡

"如果还有队友则假死，否则真死"

```typescript
{
    trigger: [{
        when: "after",
        how: "take",
        key: "healthReachMin",
        onlyKey: "default_death_on_health_zero",
        event: [{
            targetType: "self",
            key: "conditionalDeath",
            effect: [{
                key: "checkAllyCount",
                params: {
                    ifAlive: {
                        effect: [{ key: "applyState", params: { stateKey: "fake_death" } }]
                    },
                    ifDead: {
                        effect: [{ key: "kill", params: {} }]
                    }
                }
            }]
        }]
    }]
}
```

## 复活流程

### 1. revive 事件

要复活一个角色，触发 `revive` 事件：

```typescript
doEvent({
    key: "revive",
    source: reviver,
    medium: reviveItem,
    target: deadCharacter,
    effectUnits: [{
        key: "revive",
        params: {
            healAmount: 10  // 可选：复活时恢复的生命值
        }
    }]
})
```

### 2. revive 效果

`revive` 效果函数会执行：

```typescript
// lifeControl.ts - reviveTarget
export const reviveTarget: EffectFunc = (event, effect) => {
    // 检查是否已经存活
    if (getCurrentValue(target, "isAlive", 1) === 1) {
        return  // 已经存活，不重复处理
    }

    // 将 isAlive 设置为 1
    changeCurrentValue(target, "isAlive", 1, event)

    // 如果指定了恢复生命值
    if (healAmount !== undefined) {
        changeCurrentValue(target, "health", currentHealth + healAmount, event)
    }
}
```

### 3. isAlive 达到上限

当 `isAlive` 被设置为 1 时，触发 `reachMax` 回调：

```typescript
// isAlive.ts - reachMax 回调
reachMax: (event, owner) => {
    newLog(["角色复活", owner.label])

    // 触发 revived 事件（复活后事件）
    doEvent({
        key: "revived",
        source: event.source,
        medium: event.medium,
        target: owner,
        effectUnits: []
    })
}
```

## 阻止死亡（不死效果）

除了覆盖默认死亡行为，还可以通过 **before 触发器** 阻止 `kill` 事件：

```typescript
// 不死遗物
player.appendTrigger({
    when: "before",
    how: "take",
    key: "kill",
    callback: (event) => {
        if (player.state.find(s => s.key === "immortal")) {
            newLog(["不死效果触发", "免疫死亡"])

            // 移除 kill 效果
            event.effects = event.effects.filter(e => e.key !== "kill")

            // 恢复少量生命
            doEvent({
                key: "heal",
                source: player,
                target: player,
                effectUnits: [{ key: "heal", params: { value: 1 } }]
            })
        }
    }
})
```

## 战斗系统集成

### 判断存活

战斗系统使用 `isAlive` 判断角色是否存活：

```typescript
// battle.ts
getAliveEnemies(): Enemy[] {
    return this.enemyTeam.filter(chara =>
        chara instanceof Enemy && chara.current.isAlive?.value === 1
    ) as Enemy[]
}

getAlivePlayers(): Player[] {
    return this.playerTeam.filter(chara =>
        chara instanceof Player && chara.current.isAlive?.value === 1
    ) as Player[]
}
```

### 战斗结束判定

```typescript
checkBattleEnd(): "player_win" | "player_lose" | null {
    const alivePlayers = this.getAlivePlayers()
    const aliveEnemies = this.getAliveEnemies()

    if (alivePlayers.length === 0) {
        return "player_lose"
    }

    if (aliveEnemies.length === 0) {
        return "player_win"
    }

    return null
}
```

## 事件流程图

### 默认死亡流程

```
生命值达到0
  ↓
触发 healthReachMin 事件
  ↓
[默认触发器] 触发 kill 事件（带 kill 效果）
  ↓
[before kill 触发器] ← 可以在这里阻止死亡
  ↓
执行 kill 效果
  ↓
isAlive 设置为 0
  ↓
触发 death 事件
  ↓
[after death 触发器] ← 死亡后处理
```

### 假死流程

```
生命值达到0
  ↓
触发 healthReachMin 事件
  ↓
[自定义触发器] 添加假死状态（覆盖默认行为）
  ↓
角色继续存活（isAlive = 1）
  ↓
下回合开始
  ↓
[假死状态触发器] 触发复活
  ↓
恢复生命值
  ↓
移除假死状态
```

### 被阻止的死亡流程

```
生命值达到0
  ↓
触发 healthReachMin 事件
  ↓
[默认触发器] 触发 kill 事件
  ↓
[before kill 触发器] ← 不死效果触发
  ↓
移除 kill 效果 / 取消事件
  ↓
恢复生命值
  ↓
角色继续存活
```

## 关键设计点

1. **死亡行为可配置** - 通过 `onlyKey` 机制覆盖默认触发器
2. **完全数据驱动** - 所有死亡/复活逻辑都可以通过数据配置
3. **多层防护**:
   - 第一层：覆盖 `healthReachMin` 触发器（改变死亡条件）
   - 第二层：拦截 `kill` 事件（阻止死亡）
   - 第三层：`revive` 事件（死后复活）
4. **分离关注点**:
   - `healthReachMin` 事件 = 生命归0通知
   - `kill` 事件 = 尝试杀死（可被阻止）
   - `death` 事件 = 已经死亡（用于后续处理）
   - `revive` 事件 = 尝试复活
   - `revived` 事件 = 已经复活（用于后续处理）

## 相关文件

- `isAlive.ts` - isAlive 当前值配置
- `health.ts` - 生命值配置（触发 healthReachMin 事件）
- `Target.ts` - Chara 类（添加默认死亡触发器）
- `lifeControl.ts` - kill 和 revive 效果函数
- `effectMap.ts` - 效果注册
- `battle.ts` - 战斗系统集成
- `enemyTurn.ts` - 敌人回合集成
- `假死敌人示例.md` - 详细示例

## 注意事项

1. **不要直接修改 isAlive** - 总是通过 `kill` 或 `revive` 事件
2. **检查 isAlive 而不是 health** - 战斗逻辑应该检查 `isAlive` 状态
3. **使用 onlyKey 覆盖** - 自定义死亡行为时使用 `onlyKey: "default_death_on_health_zero"`
4. **复活时恢复生命** - 复活后通常需要恢复一些生命值，否则会立即再次触发 healthReachMin
5. **事件信息** - 死亡原因等信息通过 `event.info` 传递，用于日志和UI显示
6. **状态系统配合** - 假死等复杂逻辑建议使用状态系统，状态可以携带自己的触发器

