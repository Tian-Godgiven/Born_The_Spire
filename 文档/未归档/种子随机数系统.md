# 种子随机数系统

基于种子的确定性随机数生成系统，支持 SL 大法（存档读档）。

## 核心概念

确定性随机数
  相同的种子 + 相同的游戏状态 = 相同的随机结果
  支持玩家通过 SL 来重新尝试随机事件
  保证游戏体验的公平性和可预测性

游戏状态上下文
  种子由多个因素组成：游戏种子、层数、房间索引、回合数、额外上下文
  相同的游戏状态会产生相同的随机结果
  不同的上下文会产生不同的随机结果

## 基础使用

### 简单随机数生成

```typescript
import { randomInt, randomFloat, randomChance } from "@/core/hooks/random"

// 生成随机整数 [5, 10]
const damage = randomInt(5, 10, "cardDamage")

// 生成随机浮点数 [0.5, 1.5]
const multiplier = randomFloat(0.5, 1.5, "damageMultiplier")

// 30% 概率触发
if (randomChance(0.3, "critChance")) {
    // 暴击
}
```

### 从数组中随机选择

```typescript
import { randomChoice, randomChoices, randomShuffle } from "@/core/hooks/random"

// 随机选择一个元素
const card = randomChoice(availableCards, "selectCard")

// 随机选择多个元素（不重复）
const cards = randomChoices(allCards, 3, "discoverCard")

// 打乱数组
const shuffledDeck = randomShuffle(deck, "shuffleDeck")
```

### 数值波动

```typescript
import { applyVariance, VariancePresets } from "@/core/hooks/variance"

// 使用预设波动
const damage = applyVariance(100, VariancePresets.Damage)  // 90-120

// 自定义波动
const heal = applyVariance(50, {
    variance: 0.1,  // ±10%
    context: "healVariance"
})

// 自定义上下限
const cost = applyVariance(3, {
    min: 0.8,  // -20%
    max: 1.2,  // +20%
    context: "costVariance"
})
```

## 高级使用

### 获取随机数生成器

```typescript
import { getContextRandom } from "@/core/hooks/random"

// 获取基于当前游戏状态的随机数生成器
const rng = getContextRandom("myContext")

// 使用生成器
const value = rng.nextInt(1, 10)
const choice = rng.choice(array)
const shuffled = rng.shuffle(array)
```

### 自定义上下文

上下文字符串用于区分不同的随机事件，确保它们产生不同的随机结果。

```typescript
// 为不同的卡牌效果使用不同的上下文
const damage1 = randomInt(5, 10, `card:${card1.__id}`)
const damage2 = randomInt(5, 10, `card:${card2.__id}`)

// 为不同的事件使用不同的上下文
const rewardCards = randomChoices(allCards, 3, "battleReward")
const shopCards = randomChoices(allCards, 5, "shopRefresh")
```

### 派生随机数生成器

```typescript
const rng = getContextRandom("baseContext")

// 创建派生生成器（独立但确定的随机序列）
const rng1 = rng.derive("subContext1")
const rng2 = rng.derive("subContext2")

// 两个派生生成器产生不同的随机序列
const value1 = rng1.nextInt(1, 10)
const value2 = rng2.nextInt(1, 10)  // 与 value1 不同
```

## 在效果中使用

### 卡牌效果中的随机伤害

```typescript
// 方法1：使用 $random 语法（推荐）
{
    label: "随机打击",
    interaction: {
        use: {
            target: { faction: "enemy" },
            effects: [{
                key: "damage",
                params: { value: "$random[5,10]" }  // 自动使用确定性随机数
            }]
        }
    }
}

// 方法2：在效果函数中使用
export const randomDamage: EffectFunc = (event, effect) => {
    const min = effect.params.min || 5
    const max = effect.params.max || 10
    const damage = randomInt(min, max, "randomDamage")
    // ... 应用伤害
}
```

### 发现卡牌效果

```typescript
// discoverCard 效果已经使用确定性随机数
{
    label: "发现",
    interaction: {
        use: {
            target: { key: "self" },
            effects: [{
                key: "discoverCard",
                params: {
                    count: 3,        // 随机抽取3张
                    selectCount: 1,  // 选择1张
                    tags: ["attack"] // 只抽取攻击牌
                }
            }]
        }
    }
}
```

## 种子生成规则

种子由以下部分组成（按顺序）：

```
game:{游戏种子}|floor:{层数}|room:{房间索引}|turn:{回合数}|ctx:{额外上下文}
```

示例
  第1层第1个房间第3回合使用发现卡牌：
    `game:1234567890|floor:1|room:0|turn:3|ctx:discoverCard`

  第2层第5个房间的战斗奖励：
    `game:1234567890|floor:2|room:4|ctx:battleReward`

相同的种子字符串会产生相同的随机序列
  玩家在同一时机使用同一张卡牌，会得到相同的随机结果
  支持 SL 大法重新尝试

## 注意事项

**上下文的重要性**
  不同的随机事件应该使用不同的上下文
  避免使用相同的上下文导致随机结果相同
  推荐使用描述性的上下文名称（如 "discoverCard"、"battleReward"）

**随机数消耗顺序**
  每次调用 `next()` 或 `nextInt()` 都会消耗一个随机数
  相同的调用顺序会产生相同的随机序列
  改变调用顺序会改变随机结果

**避免在循环中使用相同上下文**
  如果在循环中多次生成随机数，每次都会消耗随机数生成器的状态
  如果需要独立的随机结果，为每次循环使用不同的上下文

```typescript
// 错误：所有敌人使用相同的随机序列
for (const enemy of enemies) {
    const damage = randomInt(5, 10, "enemyDamage")  // 每次都消耗同一个生成器
}

// 正确：每个敌人使用独立的随机序列
for (const enemy of enemies) {
    const damage = randomInt(5, 10, `enemyDamage:${enemy.__key}`)
}
```

**性能考虑**
  每次调用 `getContextRandom()` 都会创建新的生成器实例
  如果需要多次使用，建议保存生成器实例

```typescript
// 不推荐：多次创建生成器
const value1 = randomInt(1, 10, "myContext")
const value2 = randomInt(1, 10, "myContext")
const value3 = randomInt(1, 10, "myContext")

// 推荐：复用生成器
const rng = getContextRandom("myContext")
const value1 = rng.nextInt(1, 10)
const value2 = rng.nextInt(1, 10)
const value3 = rng.nextInt(1, 10)
```

## 相关文件

核心实现
  `src/core/utils/SeededRandom.ts` - 种子随机数生成器类
  `src/core/hooks/random.ts` - 随机数 Hook 函数
  `src/core/hooks/variance.ts` - 数值波动系统

使用示例
  `src/ui/hooks/interaction/cardChoice.ts` - 卡牌选择中的随机数使用
  `src/core/objects/system/effect/EffectFunc.ts` - 效果参数中的随机数解析
  `src/core/effects/card/cardChoice.ts` - 发现卡牌效果

## 预设波动配置

```typescript
import { VariancePresets } from "@/core/hooks/variance"

VariancePresets.None       // 无波动
VariancePresets.Tiny       // ±5%
VariancePresets.Small      // ±10%
VariancePresets.Medium     // ±15%
VariancePresets.Large      // ±20%
VariancePresets.Huge       // ±30%
VariancePresets.Damage     // -10% ~ +20%
VariancePresets.Heal       // -5% ~ +15%
VariancePresets.Cost       // -15% ~ +5%
```
