# 黑市系统配置指南

本文档说明如何配置黑市房间的各种参数。

## 基础配置

```typescript
{
    type: "blackStore",
    name: "黑市",
    organCount: 5,      // 器官数量
    relicCount: 3,      // 遗物数量
    potionCount: 3,     // 药水数量
    allowSellOrgan: true,   // 允许出售器官
    allowSellHealth: true   // 允许出售生命值
}
```

## 稀有度权重配置

控制不同稀有度物品的出现概率。

```typescript
{
    type: "blackStore",
    rarityWeights: {
        organ: {
            common: 100,      // 普通器官权重
            uncommon: 50,     // 罕见器官权重
            rare: 20,         // 稀有器官权重
            epic: 5,          // 史诗器官权重
            legendary: 1      // 传说器官权重
        },
        relic: {
            common: 100,
            uncommon: 50,
            rare: 20,
            epic: 5,
            legendary: 1
        },
        potion: {
            common: 100,
            uncommon: 50,
            rare: 20
        }
    }
}
```

**说明**
  权重越高，出现概率越大
  权重为 0 表示不会出现
  不配置则使用默认权重

**示例：只出现稀有及以上的器官**

```typescript
rarityWeights: {
    organ: {
        common: 0,
        uncommon: 0,
        rare: 50,
        epic: 30,
        legendary: 10
    }
}
```

## 器官折扣范围配置

控制出售器官时的折扣范围。

```typescript
{
    type: "blackStore",
    organDiscountRange: {
        min: 0.5,    // 最小折扣 50%
        max: 0.7     // 最大折扣 70%
    }
}
```

**说明**
  折扣是相对于购买价格的比例
  0.5 表示售价是购买价的 50%
  每个器官的折扣是随机的，但对同一器官固定
  使用确定性随机数，支持 SL 大法

**示例：高折扣黑市（70-90%）**

```typescript
organDiscountRange: {
    min: 0.7,
    max: 0.9
}
```

**示例：低折扣黑市（30-50%）**

```typescript
organDiscountRange: {
    min: 0.3,
    max: 0.5
}
```

## 遗物不重复配置

控制遗物是否可以重复出现。

```typescript
{
    type: "blackStore",
    relicUnique: {
        enabled: true,      // 是否启用不重复（默认 true）
        scope: "global"     // 不重复范围：global 或 room（默认 global）
    }
}
```

**scope 说明**
  `global`：全局不重复，整个游戏过程中每个遗物只出现一次
  `room`：房间不重复，同一个黑市房间内不重复，但不同黑市可以重复

**示例：允许遗物重复**

```typescript
relicUnique: {
    enabled: false
}
```

**示例：房间内不重复**

```typescript
relicUnique: {
    enabled: true,
    scope: "room"
}
```

## 黑白名单配置

控制哪些物品可以出现在黑市中。

```typescript
{
    type: "blackStore",
    filters: {
        organ: {
            whitelist: ["organ_001", "organ_002"],  // 只允许这些器官
            blacklist: ["organ_999"]                // 排除这些器官
        },
        relic: {
            whitelist: ["relic_001", "relic_002"],
            blacklist: ["relic_999"]
        },
        potion: {
            whitelist: ["potion_001", "potion_002"],
            blacklist: ["potion_999"]
        }
    }
}
```

**优先级**
  白名单优先级高于黑名单
  如果设置了白名单，只有白名单中的物品会出现
  如果只设置了黑名单，除了黑名单中的物品，其他都会出现

**示例：只出现特定器官**

```typescript
filters: {
    organ: {
        whitelist: ["heart", "lung", "liver"]
    }
}
```

**示例：排除某些遗物**

```typescript
filters: {
    relic: {
        blacklist: ["cursed_relic", "broken_relic"]
    }
}
```

## 完整配置示例

### 示例1：高级黑市

```typescript
{
    type: "blackStore",
    name: "高级黑市",
    organCount: 8,
    relicCount: 5,
    potionCount: 5,

    // 更多稀有物品
    rarityWeights: {
        organ: {
            common: 20,
            uncommon: 40,
            rare: 60,
            epic: 80,
            legendary: 100
        },
        relic: {
            common: 20,
            uncommon: 40,
            rare: 60,
            epic: 80,
            legendary: 100
        }
    },

    // 更高的折扣
    organDiscountRange: {
        min: 0.7,
        max: 0.9
    },

    // 遗物全局不重复
    relicUnique: {
        enabled: true,
        scope: "global"
    }
}
```

### 示例2：低级黑市

```typescript
{
    type: "blackStore",
    name: "低级黑市",
    organCount: 3,
    relicCount: 2,
    potionCount: 2,

    // 更多普通物品
    rarityWeights: {
        organ: {
            common: 100,
            uncommon: 30,
            rare: 10,
            epic: 1,
            legendary: 0
        }
    },

    // 更低的折扣
    organDiscountRange: {
        min: 0.3,
        max: 0.5
    },

    // 遗物可以重复
    relicUnique: {
        enabled: false
    }
}
```

### 示例3：主题黑市（只卖心脏类器官）

```typescript
{
    type: "blackStore",
    name: "心脏专卖店",
    organCount: 10,
    relicCount: 0,
    potionCount: 0,

    filters: {
        organ: {
            whitelist: [
                "heart_basic",
                "heart_strong",
                "heart_regenerating",
                "heart_explosive"
            ]
        }
    },

    organDiscountRange: {
        min: 0.6,
        max: 0.8
    }
}
```

### 示例4：诅咒黑市（只卖诅咒物品）

```typescript
{
    type: "blackStore",
    name: "诅咒黑市",
    organCount: 5,
    relicCount: 5,
    potionCount: 0,

    filters: {
        organ: {
            whitelist: [
                "cursed_heart",
                "cursed_lung",
                "cursed_brain"
            ]
        },
        relic: {
            whitelist: [
                "cursed_ring",
                "cursed_amulet",
                "cursed_crown"
            ]
        }
    },

    // 诅咒物品折扣很高
    organDiscountRange: {
        min: 0.8,
        max: 0.95
    },

    // 不允许出售器官（诅咒物品不能卖）
    allowSellOrgan: false
}
```

## 在代码中使用

### 注册黑市房间

```typescript
import { registerRoom } from "@/static/registry/roomRegistry"

registerRoom({
    type: "blackStore",
    key: "blackStore_advanced",
    name: "高级黑市",
    organCount: 8,
    relicCount: 5,
    potionCount: 5,
    rarityWeights: {
        organ: {
            rare: 60,
            epic: 80,
            legendary: 100
        }
    },
    organDiscountRange: {
        min: 0.7,
        max: 0.9
    }
})
```

### 动态创建黑市房间

```typescript
import { BlackStoreRoom } from "@/core/objects/room/BlackStoreRoom"

const blackStore = new BlackStoreRoom({
    type: "blackStore",
    name: "临时黑市",
    organCount: 5,
    relicCount: 3,
    potionCount: 3,
    rarityWeights: {
        organ: {
            common: 100,
            rare: 50
        }
    },
    filters: {
        organ: {
            blacklist: ["cursed_organ"]
        }
    }
})

await nowGameRun.enterRoom(blackStore)
```

## 注意事项

**稀有度权重**
  权重是相对的，不是绝对概率
  权重 100 和权重 50 的比例是 2:1
  权重为 0 表示完全不会出现

**器官折扣**
  折扣是基于购买价格计算的
  每个器官的折扣在进入黑市时确定，之后不变
  使用确定性随机数，支持 SL 大法

**遗物不重复**
  全局不重复会跨所有黑市房间
  如果遗物池耗尽，会返回空列表
  建议遗物池足够大，或使用房间级别不重复

**黑白名单**
  白名单和黑名单可以同时使用
  白名单优先级更高
  如果白名单为空，则不应用白名单过滤

**性能考虑**
  黑白名单过滤在每次生成商品时执行
  如果过滤后可用物品太少，可能无法生成足够的商品
  建议保证过滤后至少有 10 个以上的可用物品

## 相关文件

核心实现
  `src/core/objects/room/BlackStoreRoom.ts` - 黑市房间类
  `src/static/list/room/blackStore/blackStoreItemPool.ts` - 物品池管理

类型定义
  `BlackStoreRoomConfig` - 黑市房间配置接口
  `RarityWeights` - 稀有度权重接口
  `SelectionConfig` - 选择配置接口

UI 组件
  `src/ui/page/Scene/running/BlackStore.vue` - 黑市 UI（待实现）
