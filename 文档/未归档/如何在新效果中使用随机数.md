# 如何在新效果中使用随机数系统

本文档展示如何在不同场景中使用确定性随机数系统。

## 场景1：在卡牌效果中使用

### 示例：从30张随机卡牌中选择一张

```typescript
{
    label:"大发现",
    tags:["skill"],
    status:{
        cost:1,
    },
    describe:["从30张随机卡牌中选择一张加入手牌"],
    key:"original_card_00016",
    interaction:{
        use:{
            target:{key:"self"},
            effects:[{
                key:"discoverCard",
                params:{
                    count:30,              // 随机抽取30张
                    selectCount:1,         // 选择1张
                    allowDuplicate:false,  // 不允许重复
                    addToHand:true         // 加入手牌
                },
            }]
        }
    }
}
```

**说明**
  使用现有的 `discoverCard` 效果
  `count` 参数控制随机抽取的数量
  `selectCount` 参数控制玩家可以选择的数量
  `tags` 参数可以筛选特定标签的卡牌（可选）
  `addToHand` 控制是加入手牌还是卡组

### 示例：随机伤害

```typescript
{
    label:"随机打击",
    tags:["attack"],
    status:{
        cost:1,
        minDamage:5,
        maxDamage:10
    },
    describe:["造成",{key:["status","minDamage"]},"到",{key:["status","maxDamage"]},"点随机伤害"],
    key:"random_strike",
    interaction:{
        use:{
            target:{faction:"enemy"},
            effects:[{
                key:"damage",
                params:{value:"$random[5,10]"}  // 使用 $random 语法
            }]
        }
    }
}
```

**说明**
  使用 `$random[min,max]` 语法
  系统会自动使用确定性随机数
  相同的游戏状态会产生相同的随机结果

## 场景2：创建新的效果函数

### 示例：随机获得器官

```typescript
// 在 src/core/effects/organ/randomOrgan.ts
import { EffectFunc } from "@/core/objects/system/effect/EffectFunc"
import { Player } from "@/core/objects/target/Player"
import { randomChoices } from "@/core/hooks/random"
import { organList } from "@/static/list/target/organList"
import { getOrganModifier } from "@/core/objects/system/modifier/OrganModifier"

export const randomOrgan: EffectFunc = async (event, effect) => {
    const target = Array.isArray(event.target) ? event.target[0] : event.target
    if (!(target instanceof Player)) return

    const { count = 1, rarity } = effect.params

    // 筛选器官
    let availableOrgans = organList
    if (rarity) {
        availableOrgans = organList.filter(o => o.rarity === rarity)
    }

    // 使用确定性随机数选择器官
    const selectedOrgans = randomChoices(
        availableOrgans.map(o => o.key),
        count,
        "randomOrgan"  // 上下文
    )

    // 添加器官到玩家
    const organModifier = getOrganModifier(target)
    for (const organKey of selectedOrgans) {
        organModifier.addOrgansFromSource(target, [organKey])
    }
}
```

**使用方式**

```typescript
// 在 effectMap 中注册
effectMap.push({
    label: "随机获得器官",
    key: "randomOrgan",
    effect: randomOrgan
})

// 在卡牌或事件中使用
{
    label:"器官抽奖",
    interaction:{
        use:{
            target:{key:"self"},
            effects:[{
                key:"randomOrgan",
                params:{
                    count:1,
                    rarity:"rare"
                }
            }]
        }
    }
}
```

## 场景3：在房间事件中使用

### 示例：随机事件奖励

```typescript
// 在事件的选项中使用
{
    label: "神秘宝箱",
    key: "mystery_chest",
    describe: "你发现了一个神秘的宝箱...",
    choices: [{
        label: "打开宝箱",
        describe: "随机获得一个奖励",
        effects: [{
            key: "randomReward",
            params: {
                rewardTypes: ["card", "relic", "gold"],
                count: 1
            }
        }]
    }]
}
```

### 实现随机奖励效果

```typescript
// src/core/effects/reward/randomReward.ts
import { EffectFunc } from "@/core/objects/system/effect/EffectFunc"
import { randomChoice } from "@/core/hooks/random"

export const randomReward: EffectFunc = async (event, effect) => {
    const { rewardTypes, count = 1 } = effect.params

    // 使用确定性随机数选择奖励类型
    const selectedType = randomChoice(rewardTypes, "randomReward")

    switch (selectedType) {
        case "card":
            // 给予随机卡牌
            await doEvent({
                key: "giveReward",
                target: event.target,
                effectUnits: [{
                    key: "discoverCard",
                    params: { count: 3, selectCount: 1 }
                }]
            })
            break
        case "relic":
            // 给予随机遗物
            // ...
            break
        case "gold":
            // 给予金币
            // ...
            break
    }
}
```

## 场景4：在敌人行为中使用

### 示例：随机选择攻击目标

```typescript
// 在 EnemyBehavior 中使用
import { randomChoice } from "@/core/hooks/random"

class EnemyBehavior {
    selectTarget(availableTargets: Target[]): Target {
        // 使用确定性随机数选择目标
        return randomChoice(availableTargets, `enemy:${this.enemy.__key}:selectTarget`)
    }

    selectCard(availableCards: Card[]): Card {
        // 使用确定性随机数选择卡牌
        return randomChoice(availableCards, `enemy:${this.enemy.__key}:selectCard`)
    }
}
```

## 场景5：数值波动

### 示例：伤害波动

```typescript
import { applyVariance, VariancePresets } from "@/core/hooks/variance"

export const variableDamage: EffectFunc = (event, effect) => {
    const baseDamage = effect.params.value || 10

    // 使用预设波动（-10% ~ +20%）
    const actualDamage = applyVariance(baseDamage, {
        ...VariancePresets.Damage,
        context: "variableDamage"
    })

    // 应用伤害
    // ...
}
```

### 示例：自定义波动

```typescript
// 治疗波动（±15%）
const healAmount = applyVariance(50, {
    variance: 0.15,
    context: "healVariance"
})

// 成本波动（-20% ~ +10%）
const cost = applyVariance(3, {
    min: 0.8,
    max: 1.1,
    context: "costVariance"
})
```

## 最佳实践

### 1. 使用描述性的上下文

```typescript
// 好的做法
const damage = randomInt(5, 10, "cardDamage")
const cards = randomChoices(allCards, 3, "discoverCard")
const organ = randomChoice(organs, "battleReward")

// 不好的做法
const damage = randomInt(5, 10, "random")
const cards = randomChoices(allCards, 3, "a")
const organ = randomChoice(organs)  // 缺少上下文
```

### 2. 为不同实例使用不同上下文

```typescript
// 为每个敌人使用独立的随机序列
for (const enemy of enemies) {
    const damage = randomInt(5, 10, `enemy:${enemy.__key}:damage`)
}

// 为每张卡牌使用独立的随机序列
for (const card of cards) {
    const value = randomInt(1, 10, `card:${card.__id}:value`)
}
```

### 3. 复用随机数生成器

```typescript
// 如果需要多次使用，保存生成器实例
const rng = getContextRandom("myContext")
const value1 = rng.nextInt(1, 10)
const value2 = rng.nextInt(1, 10)
const value3 = rng.nextInt(1, 10)

// 而不是每次都创建新的
const value1 = randomInt(1, 10, "myContext")
const value2 = randomInt(1, 10, "myContext")
const value3 = randomInt(1, 10, "myContext")
```

### 4. 在效果参数中使用 $random

```typescript
// 推荐：使用 $random 语法（自动确定性）
{
    effects:[{
        key:"damage",
        params:{value:"$random[5,10]"}
    }]
}

// 而不是在效果函数中手动处理
export const myEffect: EffectFunc = (event, effect) => {
    const damage = randomInt(5, 10, "damage")
    // ...
}
```

## 常见问题

### Q: 如何确保每次 SL 后结果相同？

A: 只要游戏状态相同（层数、房间、回合数）且使用相同的上下文，结果就会相同。

### Q: 如何让每次结果都不同？

A: 改变游戏状态（例如进入下一回合）或使用不同的上下文。

### Q: 可以使用 Math.random() 吗？

A: 不推荐。使用 Math.random() 会导致无法支持 SL 大法。应该使用 `randomInt`、`randomFloat` 等函数。

### Q: 如何在循环中使用随机数？

A: 为每次循环使用不同的上下文，例如包含索引或对象ID：

```typescript
for (let i = 0; i < enemies.length; i++) {
    const damage = randomInt(5, 10, `enemyDamage:${i}`)
}
```

## 相关文件

核心实现
  `src/core/hooks/random.ts` - 随机数 Hook 函数
  `src/core/hooks/variance.ts` - 数值波动系统

效果示例
  `src/core/effects/card/cardChoice.ts` - 发现卡牌效果
  `src/core/objects/system/effect/EffectFunc.ts` - 效果参数解析

文档
  `文档/未归档/种子随机数系统.md` - 系统详细文档
